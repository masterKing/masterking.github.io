<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>微信抢红包插件 | masterKing 的个人博客</title><meta name="author" content="masterKing"><meta name="copyright" content="masterKing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本篇文章将介绍如何从 0 到 1 一步步实现微信抢红包插件功能，需要用到  一部能越狱的 iPhone，作者使用的 iOS12.5.7 的 5s。    推荐使用 iOS15 之前的设备，因为 iOS15 SSV 的出现诞生了一种新的越狱方案 rootless。导致很多以前能运行的越狱插件，工具都无法在 iOS15 及后续的系统上正常运行。因为这些工具大多都还没有针对 rootless 进行适配。">
<meta property="og:type" content="article">
<meta property="og:title" content="微信抢红包插件">
<meta property="og:url" content="https://masterking.github.io/2024/04/10/%E5%BE%AE%E4%BF%A1%E6%8A%A2%E7%BA%A2%E5%8C%85%E6%8F%92%E4%BB%B6/index.html">
<meta property="og:site_name" content="masterKing 的个人博客">
<meta property="og:description" content="本篇文章将介绍如何从 0 到 1 一步步实现微信抢红包插件功能，需要用到  一部能越狱的 iPhone，作者使用的 iOS12.5.7 的 5s。    推荐使用 iOS15 之前的设备，因为 iOS15 SSV 的出现诞生了一种新的越狱方案 rootless。导致很多以前能运行的越狱插件，工具都无法在 iOS15 及后续的系统上正常运行。因为这些工具大多都还没有针对 rootless 进行适配。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://masterking.github.io/images/iOSReveseEngineeringAndSecurity1.webp">
<meta property="article:published_time" content="2024-04-10T12:12:31.000Z">
<meta property="article:modified_time" content="2024-10-30T12:31:55.504Z">
<meta property="article:author" content="masterKing">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="逆向">
<meta property="article:tag" content="微信">
<meta property="article:tag" content="插件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://masterking.github.io/images/iOSReveseEngineeringAndSecurity1.webp"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://masterking.github.io/2024/04/10/%E5%BE%AE%E4%BF%A1%E6%8A%A2%E7%BA%A2%E5%8C%85%E6%8F%92%E4%BB%B6/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?e6857234b462ad05308d8b79794f0358";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":500,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '微信抢红包插件',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-30 20:31:55'
}</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg" style="background: linear-gradient( 135deg, #2c241f, #968282);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/WechatIMG1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">31</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/sileorepo/"><i class="fa-fw fas fa-shop"></i><span> sileo源</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/images/iOSReveseEngineeringAndSecurity1.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">masterKing 的个人博客</span></a><a class="nav-page-title" href="/"><span class="site-name">微信抢红包插件</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/sileorepo/"><i class="fa-fw fas fa-shop"></i><span> sileo源</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">微信抢红包插件</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-10T12:12:31.000Z" title="发表于 2024-04-10 20:12:31">2024-04-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-30T12:31:55.504Z" title="更新于 2024-10-30 20:31:55">2024-10-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/iOS-%E9%80%86%E5%90%91%E4%B8%8E%E5%AE%89%E5%85%A8/">iOS 逆向与安全</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">17.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>72分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/04/10/%E5%BE%AE%E4%BF%A1%E6%8A%A2%E7%BA%A2%E5%8C%85%E6%8F%92%E4%BB%B6/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/04/10/%E5%BE%AE%E4%BF%A1%E6%8A%A2%E7%BA%A2%E5%8C%85%E6%8F%92%E4%BB%B6/" itemprop="commentCount"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>本篇文章将介绍如何从 0 到 1 一步步实现微信抢红包插件功能，需要用到</p>
<ul>
<li><p>一部能越狱的 iPhone，作者使用的 iOS12.5.7 的 5s。</p>
<p>   推荐使用 iOS15 之前的设备，因为 iOS15 <a target="_blank" rel="noopener" href="https://theapplewiki.com/wiki/Signed_System_Volume">SSV</a> 的出现诞生了一种新的越狱方案 <a target="_blank" rel="noopener" href="https://theapplewiki.com/wiki/Rootless">rootless</a>。导致很多以前能运行的越狱插件，工具都无法在 iOS15 及后续的系统上正常运行。因为这些工具大多都还没有针对 rootless 进行适配。使用 iOS15 之前的设备能够更完美的进行教学，和拥有更好的体验。当你学有所成的时候，可以尝试对那些暂时没有适配的越狱插件，工具自己进行适配了。这里特别说明一下，rootless 越狱并不是指越狱后没有 root 权限，而是 iOS15 SSV 的出现导致即使是 root 用户也无法往系统目录（如&#x2F;System和&#x2F;usr）写入文件，类似于 macOS 上的 SIP，所以诞生了 rootless 解决方案。</p>
<p>   如果你是 iOS15 及以上的设备，那么越狱也推荐选择 rootful 越狱而不是 rootless，同样还是因为 rootless 很多工具无法使用的原因，比如砸壳工具 frida-ios-dump 在 rootless 越狱设备下大部分 App 都无法砸壳成功。作为普通用户，你可以选择 rootless 越狱，但如果你是想进行逆向学习，还是更推荐使用 rootful 越狱。</p>
</li>
<li><p>一台 Mac 电脑，作者使用的系统是 14.5。</p>
<p>  理论上来说 Linux 或 Windows 也可以，因为 Theos 支持，但是作者没有亲自实践过。</p>
</li>
<li><p>使用终端输入命令行的基本知识。比如 cd 进入目录或删除文件</p>
<p>  其实最好是有 Linux 或者 Unix 系统的基础知识。毕竟 iOS 系统内核 XNU 就是 Unix 类的系统。这一点不算是必要条件吧，可以在过程中学习。</p>
</li>
</ul>
<p>只需要具备以上先决条件即使你不了解 iOS 应用逆向开发也能实现这个功能，感受逆向开发的乐趣。而对于懂编程，对 iOS 应用逆向开发感兴趣的同学则可以通过这个实战项目，迅速的建立对 iOS 应用逆向开发的整体认知。作者将以这一实战项目为根基，实现项目过程中涉及的技术点为枝叶，建立起 iOS 应用逆向开发的知识体系。</p>
<p>从 0 到 1 实现微信抢红包项目的步骤为：</p>
<ol>
<li><a href="#1">越狱 iPhone</a> <ul>
<li><a href="#2">什么是 iPhone 越狱</a></li>
<li><a href="#3">越狱的原理</a></li>
<li><a href="#4">越狱的主要目的</a></li>
<li><a href="#5">越狱后的注意事项</a></li>
<li><a href="#6">iOS 越狱的四种类型</a></li>
<li><a href="#7">包管理器</a></li>
<li><a href="#8">越狱后常用的软件包</a></li>
<li><a href="#9">iOS 如何判断设备是否越狱</a></li>
</ul>
</li>
<li><a href="#10">脱壳微信</a><ul>
<li><a href="#11">下载 frida-ios-dump 项目</a></li>
<li><a href="#12">手机安装 frida</a></li>
<li><a href="#13">安装 frida-ios-dump 的依赖库</a></li>
<li><a href="#14">进行端口转发</a></li>
<li><a href="#15">运行 dump.py 脚本 </a></li>
</ul>
</li>
<li><a href="#16">安装 Theos 创建抢红包 tweak 项目</a></li>
<li><a href="#17">实现抢红包插件的 UI 代码</a></li>
<li><a href="#18">实现抢红包插件的功能代码</a><ul>
<li><a href="#19">1.定位收到微信消息的方法</a></li>
<li><a href="#20">2.定位打开红包的方法</a></li>
<li><a href="#21">3.静态分析开红包的方法</a></li>
<li><a href="#22">最终代码</a></li>
</ul>
</li>
</ol>
<!--
编写 tweak 的过程中用到了。。。
3. 界面分析：分析微信设置界面，实现抢红包功能 UI 界面
    * Cycript
    * Revael
    * Lookin
    * lldb 
5. 静态分析代码：反编译可执行文件，分析微信获取消息流程代码，开红包逻辑
    * MachOView，class-dump，Hopper Disassembler，ida，ghidra 等
6. 动态调试代码
    * lldb+debugserver
7. 编写插件：将我们的代码注入到app中，必要时可能需要重新签名，打包 ipa
-->

<h1 id="越狱-iPhone"><a href="#越狱-iPhone" class="headerlink" title="越狱 iPhone"></a>越狱 iPhone</h1><p>这一步不是本篇文章的重点。因为有很多更好的越狱教程，推荐个<a target="_blank" rel="noopener" href="https://ios.cfw.guide/">网站</a>，大家自己去看，选择手机实现越狱。如果对越狱比较熟悉的同学就可以直接跳过这一部分了。</p>
<p>综合考虑下来，目前 8，8plus，x 都是不错的选择，价格合适，性能够用，LCD 屏不怕长时间亮屏幕导致烧屏，且最高支持 iOS16.7.10 越狱，即使出现任何问题导致白苹果，也可以通过刷机恢复之后再次越狱。不会像后面新出的手机如果出现问题，只能更新到最新系统，结果无法越狱的尴尬。</p>
<p>但从学习逆向的角度来说，可能最高搭载 iOS12.5.7 的 iPhone 6&#x2F;6plus 是更合适的选择，一是它是 iOS15 以前的系统许多逆向相关的工具都能正常使用，二是同前面一样即使因为越狱出现了任何问题导致手机无法正常使用，也完全可以通过刷机之后重新越狱，可刷机可越狱的机型就是这么任性。</p>
<p>当然，如果你手中刚好有一台 iOS15 系统之前的 iPhone，也完全可以使用它进行逆向学习，毕竟因为越狱导致 iPhone<br>无法正常使用的情况还是蛮少的，实在不放心就将数据备份已备恢复。</p>
<p>其实越狱 iPhone 并不是逆向开发的必要条件，因为有 <a target="_blank" rel="noopener" href="https://github.com/AloneMonkey/MonkeyDev">MonkeyDev</a> 的存在可以实现在未越狱的 iOS 设备上开发插件，但在未越狱设备上开发插件时总会存在一些不方便的情况。比如一些知名的 App 都做了 CFBundleIdentifier 的防护，MonkeyDev 重签名 App 之后修改了 CFBundleIdentifier 就会导致获取不到数据的情况出现就会影响开发，虽然也可以做一些绕过措施但依旧存在其他的问题。</p>
<h2 id="什么是-iPhone-越狱"><a href="#什么是-iPhone-越狱" class="headerlink" title="什么是 iPhone 越狱"></a>什么是 iPhone 越狱</h2><p>iPhone 越狱是指通过特定工具或方法绕过苹果公司对 iOS 操作系统的限制，获取更高权限的过程。这使用户能够访问和修改系统文件、安装非苹果 App Store 中的应用程序，以及对系统进行其他未被官方允许的更改。</p>
<h2 id="越狱的原理"><a href="#越狱的原理" class="headerlink" title="越狱的原理"></a>越狱的原理</h2><p>越狱的原理主要在于利用 iOS 系统中的安全漏洞，获取 root 权限，从而绕过 Apple 的限制，允许用户安装未经过认证的应用和进行系统级的修改。一些开源的越狱工具如 <a target="_blank" rel="noopener" href="https://github.com/palera1n/palera1n">palera1n</a>，<a target="_blank" rel="noopener" href="https://github.com/opa334/Dopamine">Dopamine</a> 就是通过利用公开的 iOS 系统漏洞来实现的。</p>
<p>公开的 iOS 系统漏洞有 CVE-2021-1782，CVE-2022-32917，CVE-2021-30955 等等，CVE（Common Vulnerabilities and Exposures）是一个公共数据库，用于标识和记录已知的安全漏洞和暴露。每个 CVE 条目都有一个唯一的标识符，格式为 CVE-年份-序号。具体含义如下：</p>
<ul>
<li><strong>CVE：</strong>代表“通用漏洞和曝光”。</li>
<li><strong>年份：</strong>指出该漏洞首次被记录或公开的年份。</li>
<li><strong>序号：</strong>在该年份中，为该漏洞分配的唯一数字。</li>
</ul>
<p>至于这些公开的 iOS 系统漏洞是如何发现和记录的，一般通过以下这几种方式：</p>
<ul>
<li><p><strong>安全研究人员：</strong>独立的安全专家和研究机构会对软件和系统进行审计和测试，发现漏洞后会将其报告给开发者，并在确认后提交 CVE 申请。</p>
</li>
<li><p><strong>开发者和厂商：</strong>软件开发者和公司在进行内部安全测试时，可能会发现漏洞，并会向 CVE 数据库提交这些信息。</p>
</li>
<li><p><strong>社区报告：</strong>开源软件社区和用户在使用软件时，可能会发现安全问题并进行报告。这些报告有时会引发更深入的安全审计。</p>
</li>
<li><p><strong>安全会议和黑客大会：</strong>在这些会议上，研究人员通常会展示他们的研究成果，包括新发现的漏洞，之后这些信息可能会被记录为 CVE。</p>
</li>
<li><p><strong>自动化工具：</strong>一些工具会扫描软件和系统以发现已知的漏洞，并将结果报告给开发者或安全机构。</p>
</li>
</ul>
<p>那么安全研究人员又是如何发现漏洞的呢？一般也就是通过逆向工程，对二进制文件进行反汇编之后，分析代码的内部工作原理，找出潜在的漏洞。安全研究人员的要求通常比一般的程序员更高，主要体现在以下几个方面：</p>
<ul>
<li><p><strong>深厚的安全知识：</strong>安全研究人员需要深入了解安全理论、漏洞类型、攻击向量以及防御机制。</p>
</li>
<li><p><strong>逆向工程能力：</strong>能够反汇编和分析二进制文件，理解底层实现，以发现潜在漏洞。</p>
</li>
<li><p><strong>熟悉网络协议：</strong>对网络安全、协议分析和加密技术有深入理解，以识别网络层面的安全问题。</p>
</li>
<li><p><strong>编程能力：</strong>熟悉多种编程语言，能够编写自动化工具或脚本来测试和分析系统。</p>
</li>
<li><p><strong>持续学习：</strong>安全领域不断变化，研究人员需要跟上最新的安全威胁和防护措施，参与安全社区的讨论和研究。</p>
</li>
<li><p><strong>问题解决能力：</strong>能够分析复杂问题，进行创新性思考，以找到漏洞或制定有效的安全策略。</p>
</li>
</ul>
<h2 id="越狱的主要目的"><a href="#越狱的主要目的" class="headerlink" title="越狱的主要目的"></a>越狱的主要目的</h2><ol>
<li><strong>安装非官方应用：</strong> 越狱允许用户安装苹果官方 App Store 外的应用程序和插件。</li>
<li><strong>自定义界面：</strong> 用户可以通过越狱自定义 iOS 设备的界面和功能，如主题、图标等。</li>
<li><strong>增强功能：</strong> 可以使用各种增强功能的插件和工具，如系统优化、功能扩展等。</li>
<li><strong>完全的访问 iOS 文件系统：</strong> 越狱之后的 iOS 设备可以完全访问它的文件系统。</li>
<li><strong>提供逆向开发的环境：</strong> 越狱之后的 iOS 设备可以更方便的进行逆向开发。</li>
</ol>
<h2 id="越狱后的注意事项"><a href="#越狱后的注意事项" class="headerlink" title="越狱后的注意事项"></a>越狱后的注意事项</h2><ol>
<li>安全风险：<ul>
<li><strong>恶意软件和病毒：</strong>越狱解除了一些系统安全限制，非官方来源的应用可能包含恶意代码，增加设备感染恶意软件的风险。所以要谨慎安装不知名的插件。</li>
<li><strong>系统漏洞：</strong>越狱会使设备暴露于更大的安全漏洞中，黑客可以利用这些漏洞攻击设备。</li>
<li><strong>App 沙盒机制可能被绕过：</strong>虽然越狱不会直接破坏沙盒，但有的恶意插件可能试图绕过应用的沙盒保护，获取不应有的数据访问权限。</li>
</ul>
</li>
<li>系统稳定性降低：<ul>
<li><strong>崩溃和异常：</strong>越狱后安装的某些第三方插件和应用可能与系统不兼容，导致应用崩溃或系统不稳定，甚至出现无法启动的问题。</li>
<li><strong>电池续航缩短：</strong>某些越狱插件可能在后台耗电增加，导致设备电池续航能力下降。</li>
</ul>
</li>
<li>设备保修失效：<ul>
<li><strong>失去官方支持：</strong>苹果公司规定，越狱设备不再享有官方保修服务。如果越狱导致设备问题，官方可能拒绝维修。</li>
</ul>
</li>
<li>应用兼容性问题：<ul>
<li><strong>应用检测越狱：</strong>某些应用（如金融类、支付类、游戏类应用）可能会检测越狱状态，并拒绝在越狱设备上运行。</li>
</ul>
</li>
</ol>
<h2 id="iOS-越狱的四种类型"><a href="#iOS-越狱的四种类型" class="headerlink" title="iOS 越狱的四种类型"></a>iOS 越狱的四种类型</h2><p>有以下四种不同类型的越狱，每种类型取决于它与计算机的独立程度。</p>
<ul>
<li><p><strong>Untethered Jailbreaks 不受限制的越狱</strong></p>
<p>  不受限制的越狱可以被认为是所有越狱的圣杯。他们只需要通过网站、应用程序或计算机运行一次漏洞利用程序。之后，您的设备已完全越狱，不需要任何进一步的操作。即使您重新启动设备后，该漏洞仍将保留在设备上。</p>
<p>  不幸的是，已经很长一段时间没有为最终用户提供新的不受限制的越狱了，而且我们很可能以后都不会看到这样的越狱了。不受限制的越狱的唯一缺点是，如果出现问题，很可能会导致引导循环，要求您通过 iTunes 或 Finder（macOS Catalina 或更高版本）恢复设备。这种情况发生的可能性很低，但确实有可能。</p>
</li>
<li><p><strong>Semi-Untethered Jailbreaks 半不受限制的越狱</strong></p>
<p>  半自由越狱是近这些年来最流行的越狱类型。这种类型的越狱需要在每次重新启动或关闭 iOS 设备时执行漏洞利用。大部分是通过 iOS 设备上的应用程序或者网站运行漏洞。</p>
</li>
<li><p><strong>Semi-Tethered Jailbreaks 半受限制的越狱</strong></p>
<p>  半受限制的越狱与半不受限制的越狱非常相似，但是该漏洞必须使用计算机运行，而不是使用侧载应用程序。由于在每次重新启动 iOS 设备后需要计算机才能重新越狱，因此大多数人选择使用半不受限制的越狱。</p>
</li>
<li><p><strong>Tethered Jailbreaks 受限制的越狱</strong></p>
<p>  受限制的越狱并不适合公众使用。这些漏洞会修改设备，甚至即使没有越狱也需要 PC 才能启动。因此，这些往往只被为新版 iOS 做好准备的越狱开发人员使用。</p>
</li>
</ul>
<h2 id="包管理器"><a href="#包管理器" class="headerlink" title="包管理器"></a>包管理器</h2><p>在 iOS 设备未越狱时，我们只能通过 App Store 或爱思，沙漏这样的第三方平台下载安装应用程序。而越狱之后，我们不仅同样可以使用上面的方式下载安装应用程序，还可以通过像 Cydia，Sileo，等一些包管理器来安装 tweak，应用程序，命令行程序等其他软件。默认情况下，不同的越狱程序与不同的包管理器捆绑在一起，但目前最受欢迎的是 Sileo。</p>
<h3 id="Sileo"><a href="#Sileo" class="headerlink" title="Sileo"></a>Sileo</h3><p>Sileo 是 <a target="_blank" rel="noopener" href="https://x.com/elihwyma">Amy</a> 为 iOS 11 及更高版本维护的包管理器。 Sileo 以其基于 Swift 的设计、快速性能和总体质量改进（例如适当的 iPad 支持）而自豪。</p>
<p>Sileo 默认安装在 Electra、Chimera、Odyssey、Taurine 和 Odysseyra1n 上。 Sileo 还可以在 iOS 12.0 及更高版本上通过 checkra1n 以及 unc0ver 下载。</p>
<h3 id="Cydia"><a href="#Cydia" class="headerlink" title="Cydia"></a>Cydia</h3><p>Cydia 是一个包管理器，长期以来被认为是越狱的代表，以前是大多数越狱的首选包管理器。Cydia 的原始创建者 Saurik 已停止维护该项目，但近年来 Sam Bingner 更新了适用于现代设备和 iOS 版本的软件。</p>
<p>关于包管理器的使用，这里不做更深入的介绍了，网上有很多介绍。</p>
<blockquote>
<p>在使用包管理器安装某些应用程序之后，包管理器有时会提示我们重启 SpringBoard 。</p>
<p>SpringBoard 是 iOS 的主屏幕应用程序，管理图标、壁纸、通知等元素，就是我们接触最多的 iOS 桌面。Apple 官方有专门的岗位 iOS SpringBoard Engineer 用于开发和维护 SpringBoard 。</p>
</blockquote>
<h2 id="越狱后常用的软件包"><a href="#越狱后常用的软件包" class="headerlink" title="越狱后常用的软件包"></a>越狱后常用的软件包</h2><ul>
<li><p><strong>Apple File Conduit “2”：</strong> </p>
<p>  简称 AFC2，是一款在越狱后的 iOS 设备上使用的工具，它扩展了默认的 Apple File Conduit 服务，使得用户可以通过 USB 连接访问 iOS 文件系统中的完整内容。通常情况下，非越狱设备的文件系统只能通过 AFC 协议访问有限的部分，而 AFC2 则允许用户访问系统的根目录及其他受限制的区域。Mac 使用如 iFunBox、iExplorer、3uTools 等工具配合 AFC2 实现对越狱设备文件系统的完整访问。</p>
</li>
<li><p><strong>AppSync Unified：</strong> </p>
<p>  它允许用户在设备上安装、管理和运行非官方签名的应用程序。这类应用通常包括未通过苹果审核的应用、已修改的应用、以及自行编译或未经 App Store 发布的应用。AppSync Unified 通过补丁系统文件，绕过了 iOS 的应用签名限制。</p>
</li>
<li><p><strong>Filza File Manager：</strong> </p>
<p>  是一款功能强大的文件管理器，专为越狱后的 iOS 设备设计。它允许用户在设备上直接浏览、管理和编辑文件系统的内容。Filza 提供了与桌面操作系统文件管理器类似的体验，让用户可以轻松访问和操作 iOS 设备上的所有文件，包括系统文件和应用数据。</p>
</li>
<li><p><strong><a href="../openssh/openssh.md">OpenSSH</a></strong> </p>
<p>  是一个开源的 SSH 实现，它提供服务器的功能，用于安全远程登录、命令执行和文件传输。iOS 安装之后可以我们可以使用 Mac 远程登录到设备上。</p>
</li>
</ul>
<blockquote>
<p>如果遇到包管理器下载安装某些软件包失败的情况，可以手动安装软件包。</p>
</blockquote>
<p>如果你已经下载了 .deb 文件（iOS 软件包的格式），可以通过以下步骤在 Sileo 中进行本地安装：</p>
<ol>
<li><strong>将 .deb 文件传输到设备上：</strong>你可以使用文件管理工具或其他方法将 .deb 文件传输到你的 iOS 设备上，比如使用文件传输工具或通过越狱后的文件系统。</li>
<li><strong>使用文件管理工具访问文件：</strong>在设备上打开你用来管理文件的工具（例如 Filza File Manager）。</li>
<li><strong>找到 .deb 文件：</strong>浏览到存储 .deb 文件的目录。</li>
<li><strong>使用 Sileo 安装：</strong>在文件管理工具中找到 .deb 文件，点击它，通常会弹出一个选项，允许你选择使用 Sileo 或其他包管理工具进行安装。</li>
<li><strong>确认安装：</strong>选择 Sileo 进行安装，Sileo 将会处理包的安装过程。</li>
</ol>
<h2 id="iOS-如何判断设备是否越狱"><a href="#iOS-如何判断设备是否越狱" class="headerlink" title="iOS 如何判断设备是否越狱"></a>iOS 如何判断设备是否越狱</h2><p>iOS 可以通过多种方法来检测设备是否越狱，主要是利用越狱后系统的某些变化和越狱工具的行为。以下是常见的越狱检测方法：</p>
<h3 id="检查系统文件的存在"><a href="#检查系统文件的存在" class="headerlink" title="检查系统文件的存在"></a>检查系统文件的存在</h3><p>越狱后，一些特定的文件和目录可能会存在，正常情况下这些文件不应该存在。例如：</p>
<ul>
<li><strong>Cydia 应用的路径：</strong>&#x2F;Applications&#x2F;Cydia.app，如果这个路径存在，说明设备很可能已经越狱。</li>
<li><strong>其他越狱工具的路径：</strong>比如 Sileo.app 或者 Zebra.app。</li>
</ul>
<p>常用代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ([[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:<span class="string">@&quot;/Applications/Cydia.app&quot;</span>] ||</span><br><span class="line">    [[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:<span class="string">@&quot;/Library/MobileSubstrate/MobileSubstrate.dylib&quot;</span>] ||</span><br><span class="line">    [[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:<span class="string">@&quot;/usr/sbin/sshd&quot;</span>] ||</span><br><span class="line">    [[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:<span class="string">@&quot;/etc/apt&quot;</span>]) &#123;</span><br><span class="line">    <span class="comment">// 设备已经越狱</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但这种方式存在一个问题，即曾经越狱过的设备可能在系统中留下了这些文件，但后续升级了 iOS 之后失去了越狱状态就会导致明明是未越狱设备却被判定为越狱设备。</p>
<h3 id="检查是否能够访问系统的根目录"><a href="#检查是否能够访问系统的根目录" class="headerlink" title="检查是否能够访问系统的根目录"></a>检查是否能够访问系统的根目录</h3><p>越狱后，某些应用会获得更高权限，可以访问系统的根目录。因此，通过尝试在 &#x2F;private 目录下写入文件，可以判断设备是否越狱：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSError</span> *error;</span><br><span class="line"><span class="built_in">NSString</span> *testWrite = <span class="string">@&quot;/private/jailbreak_test.txt&quot;</span>;</span><br><span class="line">[<span class="string">@&quot;Jailbreak Test&quot;</span> writeToFile:testWrite atomically:<span class="literal">YES</span> encoding:<span class="built_in">NSUTF8StringEncoding</span> error:&amp;error];</span><br><span class="line"><span class="keyword">if</span> (error == <span class="literal">nil</span>) &#123;</span><br><span class="line">    <span class="comment">// 设备已越狱</span></span><br><span class="line">    [[<span class="built_in">NSFileManager</span> defaultManager] removeItemAtPath:testWrite error:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="检查是否可以调用-fork-函数"><a href="#检查是否可以调用-fork-函数" class="headerlink" title="检查是否可以调用 fork() 函数"></a>检查是否可以调用 fork() 函数</h3><p>iOS 设备在非越狱环境下不允许创建子进程，而越狱设备可以使用 fork() 函数来创建子进程。通过检查是否可以成功调用 fork()，可以判断设备是否越狱：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> pid = fork();</span><br><span class="line"><span class="keyword">if</span> (pid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 设备已越狱</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="检测越狱工具的存在"><a href="#检测越狱工具的存在" class="headerlink" title="检测越狱工具的存在"></a>检测越狱工具的存在</h3><p>有些应用会检查常见的越狱工具，如 Cydia 或 Sileo 是否能够被打开：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ([[<span class="built_in">UIApplication</span> sharedApplication] canOpenURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@&quot;cydia://&quot;</span>]]) &#123;</span><br><span class="line">    <span class="comment">// 设备已越狱</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="检查动态库注入"><a href="#检查动态库注入" class="headerlink" title="检查动态库注入"></a>检查动态库注入</h3><p>越狱通常会引入一些动态库来修改系统行为。可以通过查看运行时的动态库是否有常见的越狱库，例如 MobileSubstrate:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> dyld_count = _dyld_image_count();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; dyld_count; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(_dyld_get_image_name(i), <span class="string">&quot;MobileSubstrate&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 设备已越狱</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="脱壳微信"><a href="#脱壳微信" class="headerlink" title="脱壳微信"></a>脱壳微信</h1><p>对一个应用程序进行逆向分析之前，首先需要对其进行脱壳操作。至于什么是壳，请看 <a href="../binary_dumping/binary_dumping.md">iOS 应用脱壳</a></p>
<p>在 iOS12.5.7 上脱壳微信的方法有很多，这里只介绍 frida-ios-dump，要想成功脱壳还需要不少的配置和步骤。简单点来说就是使用 frida-ios-dump 需要用到 frida 等第三方库，而安装 frida 又需要用到其他的库，所以导致可能不会一次性就能成功运行脱壳。加上每个人的电脑环境不同，可能出现的问题千奇百怪，这里就记录作者本人使用过程中遇到的问题和解决的办法。</p>
<h3 id="1-手机安装-frida"><a href="#1-手机安装-frida" class="headerlink" title="1.手机安装 frida"></a>1.手机安装 frida</h3><p>在 cydia&#x2F;sileo 上添加源 <a target="_blank" rel="noopener" href="https://build.frida.re/">https://build.frida.re</a>，点击 frida 安装就好了。可以参考<a target="_blank" rel="noopener" href="https://frida.re/docs/ios/#with-jailbreak">官方文档</a> </p>
<h3 id="2-Mac下载-frida-ios-dump-项目"><a href="#2-Mac下载-frida-ios-dump-项目" class="headerlink" title="2.Mac下载 frida-ios-dump 项目"></a>2.Mac下载 <a target="_blank" rel="noopener" href="https://github.com/AloneMonkey/frida-ios-dump">frida-ios-dump</a> 项目</h3><p>这一步是最简单的，大家都是程序员的话应该不用多说了吧。在终端输入以下命令下载：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/AloneMonkey/frida-ios-dump.git</span><br></pre></td></tr></table></figure>

<h3 id="3-安装-frida-ios-dump-的依赖库"><a href="#3-安装-frida-ios-dump-的依赖库" class="headerlink" title="3.安装 frida-ios-dump 的依赖库"></a>3.安装 frida-ios-dump 的依赖库</h3><p>按照 frida-ios-dump 的文档执行 <code>sudo pip install -r requirements.txt --upgrade</code> 的时候，出现了以下错误：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> ~/frida-ios-dump/ [master*] <span class="built_in">sudo</span> pip install -r requirements.txt --upgrade</span><br><span class="line">Password:</span><br><span class="line"><span class="built_in">sudo</span>: pip: <span class="built_in">command</span> not found</span><br></pre></td></tr></table></figure>

<p>这个问题好解决，由于作者是用 brew 安装的 python3，可以使用它附带的 pip3。所以修改为 pip3 就好了。输入 <code>sudo pip3 install -r requirements.txt --upgrade</code>，还是出错了：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> ~/frida-ios-dump/ [master*] <span class="built_in">sudo</span> pip3 install -r requirements.txt --upgrade</span><br><span class="line">WARNING: The directory <span class="string">&#x27;/Users/franky/Library/Caches/pip&#x27;</span> or its parent directory is not owned or is not writable by the current user. The cache has been disabled. Check the permissions and owner of that directory. If executing pip with <span class="built_in">sudo</span>, you should use <span class="built_in">sudo</span><span class="string">&#x27;s -H flag.</span></span><br><span class="line"><span class="string">error: externally-managed-environment</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">× This environment is externally managed</span></span><br><span class="line"><span class="string">╰─&gt; To install Python packages system-wide, try brew install</span></span><br><span class="line"><span class="string">    xyz, where xyz is the package you are trying to</span></span><br><span class="line"><span class="string">    install.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If you wish to install a Python library that isn&#x27;</span>t <span class="keyword">in</span> Homebrew,</span><br><span class="line">    use a virtual environment:</span><br><span class="line"></span><br><span class="line">    python3 -m venv path/to/venv</span><br><span class="line">    <span class="built_in">source</span> path/to/venv/bin/activate</span><br><span class="line">    python3 -m pip install xyz</span><br><span class="line"></span><br><span class="line">    If you wish to install a Python application that isn<span class="string">&#x27;t in Homebrew,</span></span><br><span class="line"><span class="string">    it may be easiest to use &#x27;</span>pipx install xyz<span class="string">&#x27;, which will manage a</span></span><br><span class="line"><span class="string">    virtual environment for you. You can install pipx with</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    brew install pipx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    You may restore the old behavior of pip by passing</span></span><br><span class="line"><span class="string">    the &#x27;</span>--break-system-packages<span class="string">&#x27; flag to pip, or by adding</span></span><br><span class="line"><span class="string">    &#x27;</span>break-system-packages = <span class="literal">true</span><span class="string">&#x27; to your pip.conf file. The latter</span></span><br><span class="line"><span class="string">    will permanently disable this error.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If you disable this error, we STRONGLY recommend that you additionally</span></span><br><span class="line"><span class="string">    pass the &#x27;</span>--user<span class="string">&#x27; flag to pip, or set &#x27;</span>user = <span class="literal">true</span><span class="string">&#x27; in your pip.conf</span></span><br><span class="line"><span class="string">    file. Failure to do this can result in a broken Homebrew installation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Read more about this behavior here: &lt;https://peps.python.org/pep-0668/&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">note: If you believe this is a mistake, please contact your Python installation or OS distribution provider. You can override this, at the risk of breaking your Python installation or OS, by passing --break-system-packages.</span></span><br><span class="line"><span class="string">hint: See PEP 668 for the detailed specification.</span></span><br></pre></td></tr></table></figure>

<p>好在给出的提示足够多，解决方法也有。于是按照提示使用 python 虚拟环境。这个虚拟环境一开始给我的感觉很懵逼。但实际的做法就是在项目的目录下新建一个文件夹用于存放 python 相关的资源，这样不影响系统的 python 环境。按照提示输入以下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"> ~/frida-ios-dump/ [master] python3 -m venv path/to/venv</span><br><span class="line"> ~/frida-ios-dump/ [master] <span class="built_in">source</span> path/to/venv/bin/activate</span><br><span class="line">(venv)  ~/frida-ios-dump/ [master] pip3 install -r requirements.txt --upgrade</span><br><span class="line">Collecting asn1crypto (from -r requirements.txt (line 1))</span><br><span class="line">  Using cached asn1crypto-1.5.1-py2.py3-none-any.whl.metadata (13 kB)</span><br><span class="line">Collecting bcrypt (from -r requirements.txt (line 2))</span><br><span class="line">  Using cached bcrypt-4.2.0-cp39-abi3-macosx_10_12_universal2.whl.metadata (9.6 kB)</span><br><span class="line">Collecting cffi (from -r requirements.txt (line 3))</span><br><span class="line">  Using cached cffi-1.17.1-cp312-cp312-macosx_10_9_x86_64.whl.metadata (1.5 kB)</span><br><span class="line">Collecting colorama (from -r requirements.txt (line 4))</span><br><span class="line">  Using cached colorama-0.4.6-py2.py3-none-any.whl.metadata (17 kB)</span><br><span class="line">Collecting cryptography (from -r requirements.txt (line 5))</span><br><span class="line">  Using cached cryptography-43.0.1-cp39-abi3-macosx_10_9_universal2.whl.metadata (5.4 kB)</span><br><span class="line">Collecting enum34 (from -r requirements.txt (line 6))</span><br><span class="line">  Using cached enum34-1.1.10-py3-none-any.whl.metadata (1.6 kB)</span><br><span class="line">Collecting frida-tools (from -r requirements.txt (line 7))</span><br><span class="line">  Using cached frida_tools-13.3.0-py3-none-any.whl</span><br><span class="line">Collecting idna (from -r requirements.txt (line 8))</span><br><span class="line">  Using cached idna-3.10-py3-none-any.whl.metadata (10 kB)</span><br><span class="line">Collecting ipaddress (from -r requirements.txt (line 9))</span><br><span class="line">  Using cached ipaddress-1.0.23-py2.py3-none-any.whl.metadata (923 bytes)</span><br><span class="line">Collecting paramiko (from -r requirements.txt (line 10))</span><br><span class="line">  Using cached paramiko-3.5.0-py3-none-any.whl.metadata (4.4 kB)</span><br><span class="line">Collecting prompt-toolkit (from -r requirements.txt (line 11))</span><br><span class="line">  Using cached prompt_toolkit-3.0.48-py3-none-any.whl.metadata (6.4 kB)</span><br><span class="line">Collecting pyasn1 (from -r requirements.txt (line 12))</span><br><span class="line">  Using cached pyasn1-0.6.1-py3-none-any.whl.metadata (8.4 kB)</span><br><span class="line">Collecting pycparser (from -r requirements.txt (line 13))</span><br><span class="line">  Using cached pycparser-2.22-py3-none-any.whl.metadata (943 bytes)</span><br><span class="line">Collecting Pygments (from -r requirements.txt (line 14))</span><br><span class="line">  Using cached pygments-2.18.0-py3-none-any.whl.metadata (2.5 kB)</span><br><span class="line">Collecting PyNaCl (from -r requirements.txt (line 15))</span><br><span class="line">  Using cached PyNaCl-1.5.0-cp36-abi3-macosx_10_10_universal2.whl.metadata (8.7 kB)</span><br><span class="line">Collecting scp (from -r requirements.txt (line 16))</span><br><span class="line">  Using cached scp-0.15.0-py2.py3-none-any.whl.metadata (4.3 kB)</span><br><span class="line">Collecting six (from -r requirements.txt (line 17))</span><br><span class="line">  Using cached six-1.16.0-py2.py3-none-any.whl.metadata (1.8 kB)</span><br><span class="line">Collecting tqdm (from -r requirements.txt (line 18))</span><br><span class="line">  Using cached tqdm-4.66.5-py3-none-any.whl.metadata (57 kB)</span><br><span class="line">Collecting wcwidth (from -r requirements.txt (line 19))</span><br><span class="line">  Using cached wcwidth-0.2.13-py2.py3-none-any.whl.metadata (14 kB)</span><br><span class="line">Collecting frida&lt;17.0.0,&gt;=16.2.2 (from frida-tools-&gt;-r requirements.txt (line 7))</span><br><span class="line">  Using cached frida-16.5.5-cp37-abi3-macosx_10_13_x86_64.whl.metadata (2.0 kB)</span><br><span class="line">Collecting websockets&lt;14.0.0,&gt;=13.0.0 (from frida-tools-&gt;-r requirements.txt (line 7))</span><br><span class="line">  Using cached websockets-13.1-cp312-cp312-macosx_10_9_x86_64.whl.metadata (6.8 kB)</span><br><span class="line">Using cached asn1crypto-1.5.1-py2.py3-none-any.whl (105 kB)</span><br><span class="line">Using cached bcrypt-4.2.0-cp39-abi3-macosx_10_12_universal2.whl (472 kB)</span><br><span class="line">Using cached cffi-1.17.1-cp312-cp312-macosx_10_9_x86_64.whl (183 kB)</span><br><span class="line">Using cached colorama-0.4.6-py2.py3-none-any.whl (25 kB)</span><br><span class="line">Using cached cryptography-43.0.1-cp39-abi3-macosx_10_9_universal2.whl (6.2 MB)</span><br><span class="line">Using cached enum34-1.1.10-py3-none-any.whl (11 kB)</span><br><span class="line">Using cached idna-3.10-py3-none-any.whl (70 kB)</span><br><span class="line">Using cached ipaddress-1.0.23-py2.py3-none-any.whl (18 kB)</span><br><span class="line">Using cached paramiko-3.5.0-py3-none-any.whl (227 kB)</span><br><span class="line">Using cached prompt_toolkit-3.0.48-py3-none-any.whl (386 kB)</span><br><span class="line">Using cached pyasn1-0.6.1-py3-none-any.whl (83 kB)</span><br><span class="line">Using cached pycparser-2.22-py3-none-any.whl (117 kB)</span><br><span class="line">Using cached pygments-2.18.0-py3-none-any.whl (1.2 MB)</span><br><span class="line">Using cached PyNaCl-1.5.0-cp36-abi3-macosx_10_10_universal2.whl (349 kB)</span><br><span class="line">Using cached scp-0.15.0-py2.py3-none-any.whl (8.8 kB)</span><br><span class="line">Using cached six-1.16.0-py2.py3-none-any.whl (11 kB)</span><br><span class="line">Using cached tqdm-4.66.5-py3-none-any.whl (78 kB)</span><br><span class="line">Using cached wcwidth-0.2.13-py2.py3-none-any.whl (34 kB)</span><br><span class="line">Using cached frida-16.5.5-cp37-abi3-macosx_10_13_x86_64.whl (16.7 MB)</span><br><span class="line">Using cached websockets-13.1-cp312-cp312-macosx_10_9_x86_64.whl (155 kB)</span><br><span class="line">Installing collected packages: wcwidth, ipaddress, enum34, asn1crypto, websockets, tqdm, six, Pygments, pycparser, pyasn1, prompt-toolkit, idna, frida, colorama, bcrypt, frida-tools, cffi, PyNaCl, cryptography, paramiko, scp</span><br><span class="line">Successfully installed PyNaCl-1.5.0 Pygments-2.18.0 asn1crypto-1.5.1 bcrypt-4.2.0 cffi-1.17.1 colorama-0.4.6 cryptography-43.0.1 enum34-1.1.10 frida-16.5.5 frida-tools-13.3.0 idna-3.10 ipaddress-1.0.23 paramiko-3.5.0 prompt-toolkit-3.0.48 pyasn1-0.6.1 pycparser-2.22 scp-0.15.0 six-1.16.0 tqdm-4.66.5 wcwidth-0.2.13 websockets-13.1</span><br></pre></td></tr></table></figure>

<p>可以看到成功安装了 frida。可以使用 <code>pip3 list</code> 查看 frida 的版本号。确保 frida 的版本号和手机上的 frida 是同个版本。</p>
<h3 id="4-进行端口转发"><a href="#4-进行端口转发" class="headerlink" title="4.进行端口转发"></a>4.进行端口转发</h3><p>使用 frida-ios-dump 的前提是你的越狱设备安装并配置好了 <a href="../openssh/openssh.md">OpenSSH</a> 免密码登录。这可以看我之前写过的文章。</p>
<p>使用 iproxy 进行端口转发，<code>iproxy 2222:22</code> 通过 USB 将电脑上的 2222 端口和手机的 22 端口建立映射。这一步基本没什么问题。<code>iproxy</code> 是 <code>libimobiledevice</code> 工具集的一部分，所以通过 <code>brew</code> 安装 <code>libimobiledevice</code> 获得 <code>iproxy</code>。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install libimobiledevice</span><br></pre></td></tr></table></figure>

<p>然后在终端新开一个窗口运行 <code>iproxy 2222:22</code>，之后这个终端窗口就不接受用户输入，无法交互了，但不要关闭它，因为它一直在工作中。。。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> ~/ iproxy 2222:22</span><br><span class="line">Creating listening port 2222 <span class="keyword">for</span> device port 22</span><br><span class="line">waiting <span class="keyword">for</span> connection</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h3 id="5-运行-dump-py-脚本"><a href="#5-运行-dump-py-脚本" class="headerlink" title="5.运行 dump.py 脚本"></a>5.运行 dump.py 脚本</h3><p>在运行 dump.py 脚本之前，我们可能还需要对它进行一些修改。打开 dump.py 文件，找到下面配置，在文件的 40-43 行。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">User = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">Password = <span class="string">&#x27;alpine&#x27;</span></span><br><span class="line">Host = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">Port = <span class="number">2222</span></span><br><span class="line">KeyFileName = <span class="literal">None</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这里的密码，是你在越狱 iPhone 之后设置的密码，如果是老旧的 iOS12 越狱可能是默认的密码 alpine。如果是新一点的版本如 iOS16，则是你越狱后安装 Sileo 时设置的密码，或者后续手动设置的密码。Host 设置为 localhost，是因为我们进行了 USB 端口转发，通过 USB 连接手机，就可以实现访问电脑的 2222 端口相当于访问了手机的 22 端口。</p>
<p>修改好以上配置之后使用命令 <code>python3 dump.py -l</code> 可以列举越狱设备上可砸壳的应用程序。然后输入以下命令 <code>python3 dump.py 微信</code> 运行，就可以看到终端脱壳的过程了。如果终端没有反应，可以手动打开 微信 app。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">(venv)  ~/frida-ios-dump/ [master*] python3 dump.py 微信</span><br><span class="line">Start the target app 微信</span><br><span class="line">attach pid : 18956</span><br><span class="line">Dumping 微信 to /var/folders/rt/zkm8hst55kv45x396jh95v3h0000gn/T</span><br><span class="line">[frida-ios-dump]: Load ilink_network.framework success.</span><br><span class="line">[frida-ios-dump]: Load TPFFmpeg.framework success.</span><br><span class="line">[frida-ios-dump]: Load NewMessageRingUtil.framework success.</span><br><span class="line">[frida-ios-dump]: Load SoundTouch.framework success.</span><br><span class="line">[frida-ios-dump]: Load openssl.framework success.</span><br><span class="line">[frida-ios-dump]: Load MMRouter.framework success.</span><br><span class="line">[frida-ios-dump]: Load owl.framework success.</span><br><span class="line">[frida-ios-dump]: Load TPThirdParties.framework success.</span><br><span class="line">[frida-ios-dump]: Load andromeda.framework success.</span><br><span class="line">[frida-ios-dump]: Load matrixreport.framework success.</span><br><span class="line">[frida-ios-dump]: Load Lottie.framework success.</span><br><span class="line">[frida-ios-dump]: Load ProtobufLite.framework success.</span><br><span class="line">[frida-ios-dump]: Load App.framework success.</span><br><span class="line">[frida-ios-dump]: Load JavaScriptCore2.framework success.</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/WeChat</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/WeChat.322542873.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/WeChat&#x27;</span>&#125;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/Users/franky/frida-ios-dump/path/to/venv/lib/python3.12/site-packages/frida/core.py&quot;</span>, line 562, <span class="keyword">in</span> _on_message</span><br><span class="line">    callback(message, data)</span><br><span class="line">  File <span class="string">&quot;/Users/franky/frida-ios-dump/dump.py&quot;</span>, line 571, <span class="keyword">in</span> on_message</span><br><span class="line">    scp.get(scp_from, scp_to)</span><br><span class="line">  File <span class="string">&quot;/Users/franky/frida-ios-dump/path/to/venv/lib/python3.12/site-packages/scp.py&quot;</span>, line 286, <span class="keyword">in</span> get</span><br><span class="line">    self._recv_all()</span><br><span class="line">  File <span class="string">&quot;/Users/franky/frida-ios-dump/path/to/venv/lib/python3.12/site-packages/scp.py&quot;</span>, line 440, <span class="keyword">in</span> _recv_all</span><br><span class="line">    raise SCPException(asunicode(msg[1:]))</span><br><span class="line">scp.SCPException: scp: /var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/WeChat.322542873.fid: No such file or directory</span><br><span class="line">0.00B [00:00, ?B/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/TPThirdParties.framework/TPThirdParties</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/TPThirdParties.-1804490760.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/TPThirdParties.framework/TPThirdParties&#x27;</span>&#125;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/Users/franky/frida-ios-dump/path/to/venv/lib/python3.12/site-packages/frida/core.py&quot;</span>, line 562, <span class="keyword">in</span> _on_message</span><br><span class="line">    callback(message, data)</span><br><span class="line">  File <span class="string">&quot;/Users/franky/frida-ios-dump/dump.py&quot;</span>, line 571, <span class="keyword">in</span> on_message</span><br><span class="line">    scp.get(scp_from, scp_to)</span><br><span class="line">  File <span class="string">&quot;/Users/franky/frida-ios-dump/path/to/venv/lib/python3.12/site-packages/scp.py&quot;</span>, line 286, <span class="keyword">in</span> get</span><br><span class="line">    self._recv_all()</span><br><span class="line">  File <span class="string">&quot;/Users/franky/frida-ios-dump/path/to/venv/lib/python3.12/site-packages/scp.py&quot;</span>, line 440, <span class="keyword">in</span> _recv_all</span><br><span class="line">    raise SCPException(asunicode(msg[1:]))</span><br><span class="line">scp.SCPException: scp: /var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/TPThirdParties.-1804490760.fid: No such file or directory</span><br><span class="line">0.00B [00:00, ?B/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/TPFFmpeg.framework/TPFFmpeg</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/TPFFmpeg.-1887525640.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/TPFFmpeg.framework/TPFFmpeg&#x27;</span>&#125;</span><br><span class="line">100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12.3M/12.3M [00:00&lt;00:00, 34.7MB/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/owl.framework/owl</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/owl.348061506.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/owl.framework/owl&#x27;</span>&#125;</span><br><span class="line">100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1.36M/1.36M [00:00&lt;00:00, 15.2MB/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/ilink_network.framework/ilink_network</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/ilink_network.928538910.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/ilink_network.framework/ilink_network&#x27;</span>&#125;</span><br><span class="line">100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7.14M/7.14M [00:00&lt;00:00, 21.6MB/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/SoundTouch.framework/SoundTouch</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/SoundTouch.1717022808.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/SoundTouch.framework/SoundTouch&#x27;</span>&#125;</span><br><span class="line">100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 113k/113k [00:00&lt;00:00, 2.13MB/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/JavaScriptCore2.framework/JavaScriptCore2</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/JavaScriptCore2.514565318.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/JavaScriptCore2.framework/JavaScriptCore2&#x27;</span>&#125;</span><br><span class="line">100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12.6M/12.6M [00:00&lt;00:00, 34.6MB/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/ProtobufLite.framework/ProtobufLite</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/ProtobufLite.410267128.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/ProtobufLite.framework/ProtobufLite&#x27;</span>&#125;</span><br><span class="line">100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 544k/544k [00:00&lt;00:00, 7.19MB/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/MMRouter.framework/MMRouter</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/MMRouter.-2017767432.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/MMRouter.framework/MMRouter&#x27;</span>&#125;</span><br><span class="line">100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 96.5k/96.5k [00:00&lt;00:00, 1.82MB/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/Lottie.framework/Lottie</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/Lottie.1475886264.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/Lottie.framework/Lottie&#x27;</span>&#125;</span><br><span class="line">100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 488k/488k [00:00&lt;00:00, 9.93MB/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/andromeda.framework/andromeda</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/andromeda.419211084.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/andromeda.framework/andromeda&#x27;</span>&#125;</span><br><span class="line">100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8.50M/8.50M [00:00&lt;00:00, 34.4MB/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/openssl.framework/openssl</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/openssl.680017982.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/openssl.framework/openssl&#x27;</span>&#125;</span><br><span class="line">100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2.59M/2.59M [00:00&lt;00:00, 17.5MB/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/matrixreport.framework/matrixreport</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/matrixreport.-1076983176.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/matrixreport.framework/matrixreport&#x27;</span>&#125;</span><br><span class="line">100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469k/469k [00:00&lt;00:00, 8.20MB/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/NewMessageRingUtil.framework/NewMessageRingUtil</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/NewMessageRingUtil.709267448.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/NewMessageRingUtil.framework/NewMessageRingUtil&#x27;</span>&#125;</span><br><span class="line">100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 87.6k/87.6k [00:00&lt;00:00, 2.23MB/s]</span><br><span class="line">start dump /private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/App.framework/App</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;dump&#x27;</span>: <span class="string">&#x27;/var/mobile/Containers/Data/Application/CC606C90-0A7C-4829-B31E-3027FFFCE2D7/Documents/App.-760674948.fid&#x27;</span>, <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app/Frameworks/App.framework/App&#x27;</span>&#125;</span><br><span class="line">100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 50.6M/50.6M [00:01&lt;00:00, 38.5MB/s]</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;app&#x27;</span>: <span class="string">&#x27;/private/var/containers/Bundle/Application/2171A776-C87B-4E20-8DD4-8163443CF339/WeChat.app&#x27;</span>&#125;</span><br><span class="line">/var/folders/rt/zkm8hst55kv45x396jh95v3h0000gn/T/Payload/</span><br><span class="line">666MB [00:25, 27.1MB/s]</span><br><span class="line">0.00B [00:00, ?B/s]payload : &#123;<span class="string">&#x27;done&#x27;</span>: <span class="string">&#x27;ok&#x27;</span>&#125;</span><br><span class="line">DONE!</span><br><span class="line">0.00B [00:00, ?B/s]</span><br><span class="line">Generating <span class="string">&quot;微信.ipa&quot;</span></span><br></pre></td></tr></table></figure>

<p>输入 la 查看当前目录下，多了一个 微信.ipa 文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(venv)  ~/frida-ios-dump/ [master*] la</span><br><span class="line">total 590168</span><br><span class="line">drwxr-xr-x@ 13 franky  staff   416B  9 26 18:46 .git</span><br><span class="line">-rw-r--r--@  1 franky  staff   1.0K  5 31 20:48 LICENSE</span><br><span class="line">-rw-r--r--@  1 franky  staff   804B  5 31 20:48 README.md</span><br><span class="line">-rwxr-xr-x@  1 franky  staff    25K  9 26 11:19 dump.py</span><br><span class="line">drwxr-xr-x@  3 franky  staff    96B  9 26 18:49 path</span><br><span class="line">-rw-r--r--@  1 franky  staff   2.0K  5 31 20:48 process.sh</span><br><span class="line">-rw-r--r--@  1 franky  staff    36B  9 26 18:53 requirements.txt</span><br><span class="line">-rw-r--r--@  1 franky  staff   276M  9 26 19:35 微信.ipa</span><br></pre></td></tr></table></figure>

<p>解压缩 ipa 之后，使用 <code>otool -l Payload/WeChat.app/WeChat | grep crypt</code> 查看 WeChat 是否脱壳成功，记得一定要检查，有时候会看起一切正常然而并没有脱壳成功。如何判断是否脱壳成功呢？检查 cryptid 后面的值，是 0 就代表脱壳成功了，非 0 表示脱壳失败，该二进制文件依旧有壳。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> ~/frida-ios-dump/ [master*] otool -l Payload/WeChat.app/WeChat | grep crypt</span><br><span class="line">     cryptoff 138072064</span><br><span class="line">    cryptsize 4096</span><br><span class="line">      cryptid 0</span><br></pre></td></tr></table></figure>

<p>至此，你就得到了一个脱壳成功的 ipa 了。有了它之后才可以进行后面的分析。</p>
<h1 id="安装-Theos-创建抢红包-tweak-项目"><a href="#安装-Theos-创建抢红包-tweak-项目" class="headerlink" title="安装 Theos 创建抢红包 tweak 项目"></a>安装 Theos 创建抢红包 tweak 项目</h1><p>在 iOS 越狱环境中，”tweak” 通常指的是对系统或应用进行修改的小程序或插件。这些修改可以改变应用的外观、功能或行为。Tweaks 通常通过 Cydia、Sileo 等包管理器安装，允许用户自定义他们的设备。例如，有些 tweak 可以添加新的功能到现有的应用，或者移除一些系统限制。</p>
<p>编写 tweak 需要用到 Theos，Theos 最初是一个名为 “iphone-framework” 的项目，旨在简化命令行下的代码构建，主要用于越狱的 iOS 设备。后来，它经历了重大改进，成为 Theos —— 一个基于 Make 的灵活构建系统，专注于越狱软件开发，同时也支持为其他多个平台构建项目。安装 Theos 需要安装 Xcode 和 Homebrew。具体的安装方法可以查看 <a target="_blank" rel="noopener" href="https://theos.dev/docs/installation-macos">官方文档</a></p>
<p>Theos 安装好之后，打开终端输入以下命令 <code>nic.pl</code> 创建 tweak 项目，然后按照提示输入相关信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> ~/ nic.pl</span><br><span class="line">NIC 2.0 - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">  [1.] iphone/activator_event</span><br><span class="line">  [2.] iphone/activator_listener</span><br><span class="line">  [3.] iphone/application</span><br><span class="line">  [4.] iphone/application_swift</span><br><span class="line">  [5.] iphone/application_swiftui</span><br><span class="line">  [6.] iphone/control_center_module-11up</span><br><span class="line">  [7.] iphone/cydget</span><br><span class="line">  [8.] iphone/flipswitch_switch</span><br><span class="line">  [9.] iphone/framework</span><br><span class="line">  [10.] iphone/library</span><br><span class="line">  [11.] iphone/notification_center_widget</span><br><span class="line">  [12.] iphone/notification_center_widget-7up</span><br><span class="line">  [13.] iphone/null</span><br><span class="line">  [14.] iphone/preference_bundle</span><br><span class="line">  [15.] iphone/preference_bundle_swift</span><br><span class="line">  [16.] iphone/theme</span><br><span class="line">  [17.] iphone/tool</span><br><span class="line">  [18.] iphone/tool_swift</span><br><span class="line">  [19.] iphone/tweak</span><br><span class="line">  [20.] iphone/tweak_swift</span><br><span class="line">  [21.] iphone/tweak_with_simple_preferences</span><br><span class="line">  [22.] iphone/xpc_service</span><br><span class="line">  [23.] iphone/xpc_service_modern</span><br><span class="line">Choose a Template (required): 19</span><br><span class="line">Project Name (required): redEnveloper</span><br><span class="line">Package Name [com.yourcompany.redenveloper]:</span><br><span class="line">Author/Maintainer Name [franky]:</span><br><span class="line">[iphone/tweak] MobileSubstrate Bundle filter [com.apple.springboard]: com.tencent.xin</span><br><span class="line">[iphone/tweak] List of applications to terminate upon installation (space-separated, <span class="string">&#x27;-&#x27;</span> <span class="keyword">for</span> none) [SpringBoard]: WeChat</span><br><span class="line">Instantiating iphone/tweak <span class="keyword">in</span> redEnveloper/...</span><br><span class="line">Done.</span><br></pre></td></tr></table></figure>

<p>这里我们填写了工程名为 redEnveloper</p>
<p>然后在 <code>[iphone/tweak] MobileSubstrate Bundle filter [com.apple.springboard]:</code> 这一栏输入的 <code>com.tencent.xin</code> 是微信的唯一标识，也就是 CFBundleIdentifier，至于如何知道微信的 CFBundleIdentifier 是这个的，其实有很多方法。。。</p>
<p>然后在 <code>[iphone/tweak] List of applications to terminate upon installation (space-separated, &#39;-&#39; for none) [SpringBoard]: </code> 这一栏输入 <code>WeChat</code> 这是微信的进程名。</p>
<p>其他项都可以直接回车使用默认值就行了。我们先认识一下 tweak 项目都有哪些文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> ~/redEnveloper/ tree</span><br><span class="line">.</span><br><span class="line">├── Makefile</span><br><span class="line">├── Tweak.xm</span><br><span class="line">├── control</span><br><span class="line">└── redEnveloper.plist</span><br><span class="line"></span><br><span class="line">1 directory, 4 files</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>tree</code> 命令默认是没有的，可以使用 <code>brew install tree</code> 安装。</p>
</blockquote>
<p>在 iOS Tweak 项目中，这些文件和文件夹的作用如下：</p>
<ol>
<li><p><strong>Makefile</strong>：用于编译和构建你的 tweak。它定义了如何将源代码（如 Tweak.x）编译成动态库，包括所需的编译器选项和依赖关系。</p>
</li>
<li><p><strong>Tweak.x</strong>：这是你的插件主要源代码文件，通常包含了你想要实现的功能的代码。你可以在这里编写用于修改系统行为或应用程序功能的代码。</p>
</li>
<li><p><strong>control</strong>：这个文件包含关于你的 tweak 的元数据，例如名称、版本、作者、依赖关系等。它通常用于生成一个可安装的包。</p>
</li>
<li><p><strong>packages</strong>：这个文件夹通常用于存放编译后的 deb 包，方便发布和安装。</p>
</li>
<li><p><strong>redEnveloper.plist</strong>：这是一个属性列表文件，这个部分用于定义哪些应用程序的行为会受到你的 tweak 影响。</p>
</li>
</ol>
<h1 id="实现抢红包插件的-UI-代码"><a href="#实现抢红包插件的-UI-代码" class="headerlink" title="实现抢红包插件的 UI 代码"></a>实现抢红包插件的 UI 代码</h1><p>实现微信自动抢红包功能可以完全不提供 UI 界面，这样每个红包消息过来的时候就自动拆开了。但这样不太好，而且实际的情况下不合适的红包自动抢了会很尴尬，另外从学习逆向开发的角度来说，多练习下也是不错的。但这个功能 UI 不是重点，所以我们还是尽可能的简单处理，只在微信的设置页面添加一个 cell 左边显示自动抢红包功能，右边显示一个开关用来控制该功能。</p>
<p>现在很多人可能会好奇，Tweak.x 编写什么代码呢？.x 文件里面写 Logos 语法的代码。Logos 是一个基于 Perl 语言的正则表达式的预处理器，它通过优雅的类似 Objective-C 的语法简化了为 Objective-C 方法和 C 函数创建 hook 所需的模板代码。如果熟悉 Objective-C 的 runtime 的话，就可以理解为 Logos 语法将平时我们自己通过 runtime 编写的 hook 代码简化了。Logos 语法也没有很多，官方文档在<a target="_blank" rel="noopener" href="https://theos.dev/docs/logos-syntax">这里</a>。</p>
<p>了解或熟悉 Logos 语法之后，接下来就是考虑对哪些类，哪些方法进行 hook 了，至于什么是 hook，<a href="hook/hook.md">这篇文章</a> 有介绍。按照刚刚所说的 UI 需求的话，就需要分析微信的设置界面所用的类，和实现的逻辑了。这里会用到界面分析工具 <a href="%E8%BF%99%E9%87%8C%E5%86%99%E8%BF%87%E6%96%87%E7%AB%A0">Reveal</a> 或者 Lookin 等类似工具用于查看设置界面的控制器类，也可以用 <a href="%E8%BF%99%E9%87%8C%E5%86%99%E8%BF%87%E6%96%87%E7%AB%A0">cycript</a>，<a href="%E8%BF%99%E9%87%8C%E4%B9%9F%E6%9C%89%E6%96%87%E7%AB%A0%E4%BA%86">lldb</a> 等命令行工具查看。知道了是哪个控制器类之后，就可以使用 <a href="%E9%9C%80%E8%A6%81%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0">class-dump</a> 工具对前面脱壳过的微信可执行文件导出所有的头文件，阅读对应的控制器类的头文件了。再结合正向开发的经验，分析应该 hook 哪些类的哪些方法。</p>
<p>这里我们以 Reveal 为例，作者使用的是 Reveal46，因为 Reveal47 要求 iOS13 以上了，老版本可以在<a target="_blank" rel="noopener" href="https://revealapp.com/updates/46/">官网下载</a>。</p>
<p>在手机上的 Cydia 搜索安装 Reveal2Loader 并安装。安装成功之后还需要再去设置中，找到 Reveal 项，进入 Enabled Applications 打开微信的右侧开关，这样才会在启动微信的时候注入 Reveal 服务。Reveal2Loader 自带的 RevealServer.framework 很古老了，大概率和你 Mac 上的 Reveal 是不匹配的，但是不用担心，可以将 Mac 上 Reveal 的 RevealServer.framework 复制到越狱设备的 &#x2F;Library&#x2F;Frameworks 文件夹下。可以使用任何你熟悉的方式，如：使用 iFunBox，使用 scp 命令。这里以 scp 命令为例子：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> ~/ scp -r -P 2222 /Applications/Reveal.app/Contents/SharedSupport/iOS-Libraries/RevealServer.framework root@localhost:/Library/Frameworks</span><br><span class="line">CodeResources                                                                                                                                                100% 2754     1.1MB/s   00:00</span><br><span class="line">RevealServer.h                                                                                                                                               100%  309   197.0KB/s   00:00</span><br><span class="line">RevealServer                                                                                                                                                 100%   12MB  38.1MB/s   00:00</span><br><span class="line">copy_and_codesign_revealserver.sh                                                                                                                            100% 1399   700.3KB/s   00:00</span><br><span class="line">module.modulemap                                                                                                                                             100%  105    59.6KB/s   00:00</span><br><span class="line">Info.plist</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：需要提前进行端口转发 iproxy 2222:22</p>
</blockquote>
<p>RevealServer.framework 的路径可以通过下图中的方式找到</p>
<p><img src="Xnip2024-10-13_00-59-11.jpg"></p>
<p>如果你使用的是较新的 iOS 版本，可能 Reveal2Loader 或者 LookinLoader 都无法正常使用了，没关系，作者都已经发布了适配 rootless 越狱的和较新版本的 <a target="_blank" rel="noopener" href="https://github.com/masterKing/RevealLoader2">RevealLoader2</a> 和 <a target="_blank" rel="noopener" href="https://github.com/masterKing/LookinLoader2">LookinLoader2</a>。</p>
<p>最终，越狱设备打开微信进入到设置页面并且 Mac 打开 Reveal，就可以在 Reveal 中看到微信 APP 了。我们选择带有 USB 图标的微信，这是通过 USB 进行数据传输的方式，另一个是通过 WiFi 传输数据，在网络不好的情况下会比较慢。</p>
<p>Reveal 的显示如下图：</p>
<p><img src="Xnip2024-10-13_13-09-41.jpg"></p>
<p>如果 <code>WCTableView</code> 对象的数据源就是 <code>NewSettingViewController</code> 对象那就可以直接对 <code>NewSettingViewController</code> 进行 hook 了。但如果不是的话，就没有必要对 <code>NewSettingViewController</code> 进行 hook 了没有意义。Reveal 无法进行命令交互，给我们提供更多的信息，这一点 Lookin 做的更好。这时，可以使用 cycript 或 lldb 进行验证。这里以 cycript 为例：</p>
<p>在越狱设备上进入 Cydia，搜索 Cycript 并安装，之后我们远程登录到越狱设备就可以使用 Cycript 了。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> ~/ ssh root@localhost -p 2222</span><br><span class="line">iPhone5s:~ root# cycript -p WeChat</span><br><span class="line">cy# <span class="comment">#0x117f56e00</span></span><br><span class="line"><span class="comment">#&quot;&lt;WCTableView: 0x117f56e00; baseClass = UITableView; frame = (0 0; 320 568); clipsToBounds = YES; gestureRecognizers = &lt;NSArray: 0x286cee370&gt;; layer = &lt;CALayer: 0x2827e89e0&gt;; contentOffset: &#123;0, -64&#125;; contentSize: &#123;320, 942&#125;; adjustedContentInset: &#123;64, 0, 0, 0&#125;&gt;&quot;</span></span><br><span class="line">cy# <span class="comment">#0x117f56e00.dataSource</span></span><br><span class="line"><span class="comment">#&quot;&lt;WCTableViewManager: 0x286cef9f0&gt;&quot;</span></span><br><span class="line">cy#</span><br></pre></td></tr></table></figure>

<blockquote>
<p>提示：0x117f56e00 这个内存地址是从 Reveal 中获取的</p>
</blockquote>
<p>结果发现 <code>WCTableView</code> 对象 0x117f56e00 的 <code>dataSource</code> 并不是控制器 <code>NewSettingViewController</code> 而是一个 <code>WCTableViewManager</code> 类的对象。那么接下来就是对 <code>WCTableViewManager</code> 类的头文件进行分析了。其实知道了 <code>WCTableView</code> 的数据源是 <code>WCTableViewManager</code> 之后也可以不用再分析下去了，<code>WCTableViewManager</code> 一定会实现 <code>UITableView</code> 的数据源方法的。但是为了方便后面编写 tweak 代码，我们这里还是要介绍一下 class-dump。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nygard/class-dump">class-dump</a> 是一个用于从 macOS 和 iOS 应用的 Mach-O 可执行文件中提取 Objective-C 类、协议和方法声明的工具。它不进行完整的反汇编或反编译，而是专注于提取头文件（.h 文件）中的结构信息，从而帮助开发者和逆向工程师了解应用的类结构和接口。</p>
<p>使用 class-dump 提取微信的头文件的命令如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> ~/frida-ios-dump/ [master*] class-dump -H Payload/WeChat.app/WeChat -o WeChatHeaders</span><br><span class="line">2024-10-06 20:38:38.536 class-dump[80038:3372682] Unknown load <span class="built_in">command</span>: 0x00000032</span><br><span class="line">2024-10-06 20:38:52.655 class-dump[80038:3372682] Warning: Parsing instance variable <span class="built_in">type</span> failed, ready_</span><br><span class="line">2024-10-06 20:38:58.673 class-dump[80038:3372682] Warning: Parsing instance variable <span class="built_in">type</span> failed, scheme</span><br><span class="line">2024-10-06 20:38:58.673 class-dump[80038:3372682] Warning: Parsing instance variable <span class="built_in">type</span> failed, queue</span><br><span class="line">2024-10-06 20:38:58.676 class-dump[80038:3372682] Warning: Parsing instance variable <span class="built_in">type</span> failed, svrID</span><br><span class="line">...</span><br><span class="line">省略很多打印</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这里我们需要用到刚刚砸壳成功的微信，否则是无法成功提取头文件的。使用 <code>la</code> 查看当前文件夹下的内容，可以看到多了一个 WeChatHeaders 的文件，里面有接近3万个的头文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> ~/frida-ios-dump/ [master*] la</span><br><span class="line">total 526064</span><br><span class="line">-rw-r--r--@     1 Franky  staff   6.0K Jul  2 16:39 .DS_Store</span><br><span class="line">drwxr-xr-x     13 Franky  staff   416B Oct  6 18:57 .git</span><br><span class="line">-rw-r--r--      1 Franky  staff    30B May  4  2023 .gitignore</span><br><span class="line">-rw-r--r--      1 Franky  staff   1.0K May  4  2023 LICENSE</span><br><span class="line">drwxr-xr-x      3 Franky  staff    96B Oct  6 20:29 Payload</span><br><span class="line">-rw-r--r--@     1 Franky  staff   3.2K May  4  2023 README.md</span><br><span class="line">drwxr-xr-x  29607 Franky  staff   925K Oct  6 20:39 WeChatHeaders</span><br><span class="line">-rw-r--r--      1 Franky  staff    11K May  4  2023 dump.js</span><br><span class="line">-rwxr-xr-x@     1 Franky  staff    11K Apr  2  2024 dump.py</span><br><span class="line">-rwxr-xr-x      1 Franky  staff   2.0K May  4  2023 process.sh</span><br><span class="line">-rw-r--r--@     1 Franky  staff   157B May  4  2023 requirements.txt</span><br><span class="line">-rw-r--r--      1 Franky  staff   255M Oct  6 20:30 微信.ipa</span><br></pre></td></tr></table></figure>

<p>使用 Sublime Text 打开这个 WeChatHeaders 文件夹，Sublime 是一个编辑器，对于这种上万份的头文件不推荐用 Xcode 打开，会很卡顿。当然也可以用你熟悉的其他编辑器打开。搜索 <code>WCTableViewManager</code> 就可以看到对应的头文件内容了。</p>
<p><img src="Xnip2024-10-06_20-49-33.png"></p>
<p>有了这个头文件之后，我们在编写 tweak 的时候，就可以方便的进行复制粘贴了，而不是每一行每一句代码，如这里的 <code>UITableView</code> 的数据源方法都自己敲一遍。</p>
<p>最后同样是使用 Sublime 打开我们之前创建 tweak 项目，选择 Tweak.x 文件删掉默认生成的代码进行编辑，代码如下：</p>
<figure class="highlight objective-c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="comment">// 界面代码</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WCTableViewManager</span></span></span><br><span class="line">- (<span class="type">long</span> <span class="type">long</span>)numberOfSectionsInTableView:(<span class="type">id</span>)arg1;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">%hook WCTableViewManager</span><br><span class="line"></span><br><span class="line">- (<span class="type">double</span>)tableView:(<span class="built_in">UITableView</span> *)tableView heightForRowAtIndexPath:(<span class="type">id</span>)indexPath&#123;</span><br><span class="line">    <span class="keyword">if</span>([tableView.nextResponder.nextResponder isKindOfClass:%c(NewSettingViewController)]</span><br><span class="line">       &amp;&amp;([indexPath section] == [<span class="keyword">self</span> numberOfSectionsInTableView:tableView] - <span class="number">1</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">44</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="type">id</span>)indexPath&#123;</span><br><span class="line">    <span class="keyword">if</span>([tableView.nextResponder.nextResponder isKindOfClass:%c(NewSettingViewController)]</span><br><span class="line">       &amp;&amp;([indexPath section] == [<span class="keyword">self</span> numberOfSectionsInTableView:tableView] - <span class="number">1</span>))&#123;</span><br><span class="line">        <span class="built_in">UITableViewCell</span> * cell = [[<span class="built_in">UITableViewCell</span> alloc] initWithStyle:(<span class="built_in">UITableViewCellStyleDefault</span>) reuseIdentifier:<span class="literal">nil</span>];</span><br><span class="line">        cell.backgroundColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line">        <span class="keyword">if</span>([indexPath row] == <span class="number">0</span>)&#123;</span><br><span class="line">            cell.textLabel.text = <span class="string">@&quot;自动抢红包&quot;</span>;</span><br><span class="line">            <span class="built_in">UISwitch</span> * switchView = [[<span class="built_in">UISwitch</span> alloc] init];</span><br><span class="line">            switchView.on = [[<span class="built_in">NSUserDefaults</span> standardUserDefaults] boolForKey:<span class="string">@&quot;RESWITCHKEY&quot;</span>];</span><br><span class="line">            [switchView addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(switchChang:) forControlEvents:(<span class="built_in">UIControlEventValueChanged</span>)];</span><br><span class="line">            cell.accessoryView = switchView;</span><br><span class="line">            <span class="built_in">NSBundle</span> *bundle = [<span class="built_in">NSBundle</span> bundleWithPath:<span class="string">@&quot;/Library/MobileSubstrate/DynamicLibraries/redEnveloper.bundle/&quot;</span>];</span><br><span class="line">            <span class="built_in">NSString</span> *imageName = ([[<span class="built_in">NSUserDefaults</span> standardUserDefaults] boolForKey:<span class="string">@&quot;RESWITCHKEY&quot;</span>] == <span class="number">1</span>) ? <span class="string">@&quot;locked.png&quot;</span> : <span class="string">@&quot;unlocked.png&quot;</span>;</span><br><span class="line">            <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageNamed:imageName inBundle:bundle compatibleWithTraitCollection:<span class="literal">nil</span>];</span><br><span class="line">            cell.imageView.image = image;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cell;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">long</span> <span class="type">long</span>)tableView:(<span class="built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="type">long</span> <span class="type">long</span>)section&#123;</span><br><span class="line">    <span class="keyword">if</span>([tableView.nextResponder.nextResponder isKindOfClass:%c(NewSettingViewController)]</span><br><span class="line">       &amp;&amp;(section == [<span class="keyword">self</span> numberOfSectionsInTableView:tableView] - <span class="number">1</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">long</span> <span class="type">long</span>)numberOfSectionsInTableView:(<span class="built_in">UITableView</span> *)tableView&#123;</span><br><span class="line">    <span class="keyword">if</span>([tableView.nextResponder.nextResponder isKindOfClass:%c(NewSettingViewController)])&#123;</span><br><span class="line">        <span class="keyword">return</span> %orig+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%new</span><br><span class="line">-(<span class="type">void</span>)switchChang:(<span class="built_in">UISwitch</span> *)switchView&#123;</span><br><span class="line">    [[<span class="built_in">NSUserDefaults</span> standardUserDefaults] setBool:switchView.isOn forKey:<span class="string">@&quot;RESWITCHKEY&quot;</span>];</span><br><span class="line">    [[<span class="built_in">NSUserDefaults</span> standardUserDefaults] synchronize];</span><br><span class="line">    [MSHookIvar&lt;<span class="built_in">UITableView</span> *&gt;(<span class="keyword">self</span>,<span class="string">&quot;_tableView&quot;</span>) reloadData];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>这段代码对于有经验的 iOS 应用开发者来说，即很熟悉又有点陌生，陌生的是一些 Logos 语法，而熟悉的是这代码基本就像是 Objective-C。这段代码中的<code>[MSHookIvar&lt;UITableView *&gt;(self,&quot;_tableView&quot;) reloadData];</code>用到了 Objective-C++ 的语法，直接编译会不通过。需要将 tweak.x 改为 tweak.xm，同时修改 Makefile 中的 <code>redEnveloper_FILES = Tweak.x</code> 为 <code>redEnveloper_FILES = Tweak.xm</code>。这样才能通过编译。同时我们使用了两张图片作为开关的状态显示。最终项目的结构如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> ~/redEnveloper/ tree</span><br><span class="line">.</span><br><span class="line">├── Makefile</span><br><span class="line">├── Tweak.xm</span><br><span class="line">├── control</span><br><span class="line">├── layout</span><br><span class="line">│   └── Library</span><br><span class="line">│       └── MobileSubstrate</span><br><span class="line">│           └── DynamicLibraries</span><br><span class="line">│               └── redEnveloper.bundle</span><br><span class="line">│                   ├── locked.png</span><br><span class="line">│                   └── unlocked.png</span><br><span class="line">└── redEnveloper.plist</span><br><span class="line"></span><br><span class="line">6 directories, 6 files</span><br></pre></td></tr></table></figure>

<p>其中 layout 及下面的子文件夹是我们自己创建的，在编译的时候，Thoes 会将这个文件夹下面的内容移动到越狱设备的对应文件路径下。意思就是在编译安装之后，越狱设备的 <code>/Library/MobileSubstrate/DynamicLibraries/redEnveloper.bundle</code> 路径下放了两张图片。这个 layout 文件夹相当于 iOS 文件系统的根目录一样。</p>
<p>这样界面相关的代码就全部完成了。我们编译打包安装看看效果：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> ~/iOSREProject/redEnveloper/ make clean &amp;&amp; make package &amp;&amp; make install</span><br><span class="line">==&gt; Cleaning…</span><br><span class="line">&gt; Making all <span class="keyword">for</span> tweak redEnveloper…</span><br><span class="line">==&gt; Preprocessing Tweak.xm…</span><br><span class="line">==&gt; Preprocessing Tweak.xm…</span><br><span class="line">==&gt; Compiling Tweak.xm (arm64)…</span><br><span class="line">==&gt; Compiling Tweak.xm (arm64e)…</span><br><span class="line">==&gt; Linking tweak redEnveloper (arm64)…</span><br><span class="line">ld: warning: -multiply_defined is obsolete</span><br><span class="line">==&gt; Generating debug symbols <span class="keyword">for</span> redEnveloper…</span><br><span class="line">==&gt; Linking tweak redEnveloper (arm64e)…</span><br><span class="line">ld: warning: -multiply_defined is obsolete</span><br><span class="line">==&gt; Generating debug symbols <span class="keyword">for</span> redEnveloper…</span><br><span class="line">==&gt; Merging tweak redEnveloper…</span><br><span class="line">==&gt; Signing redEnveloper…</span><br><span class="line">&gt; Making stage <span class="keyword">for</span> tweak redEnveloper…</span><br><span class="line">dm.pl: building package `com.yourcompany.redenveloper:iphoneos-arm<span class="string">&#x27; in `./packages/com.yourcompany.redenveloper_0.0.1-15+debug_iphoneos-arm.deb&#x27;</span></span><br><span class="line">==&gt; Installing…</span><br><span class="line">(Reading database ... 7856 files and directories currently installed.)</span><br><span class="line">Preparing to unpack /tmp/_theos_install.deb ...</span><br><span class="line">Unpacking com.yourcompany.redenveloper (0.0.1-15+debug) over (0.0.1-14+debug) ...</span><br><span class="line">Setting up com.yourcompany.redenveloper (0.0.1-15+debug) ...</span><br><span class="line">Processing triggers <span class="keyword">for</span> org.coolstar.sileo (2.5) ...</span><br><span class="line">Not running <span class="keyword">in</span> Sileo. Trigger UICache</span><br><span class="line">==&gt; Unloading WeChat…</span><br></pre></td></tr></table></figure>

<p>这里使用了 <code>&amp;&amp;</code> 符号将多个命令合并一起执行了。命令运行时，手机上的微信会被杀死。命令完成后我们打开微信，进入设置页面，滑倒最底部就会看到新增的界面了。 </p>
<img src="IMG_0002.PNG" alt="IMG_0002.PNG" width="50%">



<h1 id="实现抢红包插件的功能代码"><a href="#实现抢红包插件的功能代码" class="headerlink" title="实现抢红包插件的功能代码"></a>实现抢红包插件的功能代码</h1><p>实现自动抢红包功能的思路就是，在我们收到消息的时候，判断是红包消息，就调用打开红包的代码。完整的分析流程会十分耗时耗力，这里只大概的讲述一下。实际完成抢红包功能之后就会发现，实际所写的代码并不多，但是分析出如何写才是真正耗费时间精力的地方。</p>
<h2 id="1-定位收到微信消息的方法"><a href="#1-定位收到微信消息的方法" class="headerlink" title="1.定位收到微信消息的方法"></a>1.定位收到微信消息的方法</h2><p>为了定位收到微信消息的方法，我们可以从聊天页面出发，hook 聊天页面的所有方法，然后让对方发送消息过来，从而发现接收消息时调用了哪些方法。</p>
<p>Theos 附带了一个 logify.pl 命令行程序，它将 Objective-C 头文件（或任何包含 @interface 和方法定义的文件）转换为 Logos 输入文件，以便记录和打印所有函数调用。先使用 Reveal 查看微信聊天页面，可以知道是 <code>BaseMsgContentViewController</code> 类。然后将使用 logify.pl 将这个类的头文件转成 xm 文件并添加到我们抢红包的 tweak 工程中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> ~/frida-ios-dump/ [master*] <span class="built_in">cd</span> ~/redEnveloper</span><br><span class="line"> ~/redEnveloper/ logify.pl ~/frida-ios-dump/WeChatHeaders/BaseMsgContentViewController.h &gt; ./BaseMsgContentViewController.xm</span><br><span class="line"> ~/redEnveloper/ <span class="built_in">ls</span></span><br><span class="line">BaseMsgContentViewController.xm Tweak.xm                        layout                          redEnveloper.plist</span><br><span class="line">Makefile                        control                         packages</span><br></pre></td></tr></table></figure>

<p>可以看到使用 logify.pl 之后多出了一个 <code>BaseMsgContentViewController.xm</code> 文件。还需要在 Makefile 文件中添加这个文件，Theos 才会在编译时处理这个文件。makefile 文件内容如下所示:</p>
<figure class="highlight objective-c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">TARGET := iphone:clang:latest:<span class="number">7.0</span></span><br><span class="line">INSTALL_TARGET_PROCESSES = WeChat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">include $(THEOS)/makefiles/common.mk</span><br><span class="line"></span><br><span class="line">TWEAK_NAME = redEnveloper</span><br><span class="line"></span><br><span class="line">redEnveloper_FILES = Tweak.xm BaseMsgContentViewController.xm</span><br><span class="line">redEnveloper_CFLAGS = -fobjc-arc</span><br><span class="line"></span><br><span class="line">include $(THEOS_MAKE_PATH)/tweak.mk</span><br></pre></td></tr></table></figure>

<p>这个时候<code>make package</code>会报很多错误，主要是 logify.pl 生成的文件并不能直接使用，我们一起解决:</p>
<ul>
<li>添加 <code>UIKit</code> 头文件</li>
<li>声明用到的类和协议</li>
<li>移除 <code>- (void).cxx_destruct &#123; %log; %orig; &#125;</code> 方法</li>
<li>将 <code>CDUnknownBlockType</code> 改为 id</li>
<li>删掉 <code>inout</code> </li>
<li>Makefile 中给 redEnveloper_CFLAGS &#x3D; -fobjc-arc 后面添加 -Wno-ignored-qualifiers 编译器标记</li>
</ul>
<p>再次<code>make package</code>就可以成功编译了。之后<code>make install</code>安装到越狱设备上。我们在微信的聊天页面等待接收消息，然后打开 Mac 的控制台程序，选择我们的越狱设备，右侧搜索框输入 WeChat 过滤其他不关心的打印信息。接下来就可以给我们的越狱设备发生微信消息了，查看控制器台的打印信息，可以发现每次收到新消息的时候，都会调用以下这些方法，而高亮选中的方法带有一个 <code>addMessageNode:</code> 参数令人感到兴奋。</p>
<p><img src="Xnip2024-10-13_15-09-33.jpg"></p>
<p>尝试对这个方法下断点，打印它的调用堆栈，看能否看到有用的信息。这里运用到了 lldb+debugserver 远程调试</p>
<p>debugserver 和 lldb 是可以通过无线网络进行连接的，但是为了速度考虑，我们还是通过 USB 进行连接会更好，所以我们先进行端口映射，将越狱设备的 3333 端口和 Mac 电脑的 3333 端口关联。然后都通过访问本机的 3333 端口就可以通过 USB 建立连接了。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> ~/ iproxy 3333:3333</span><br><span class="line">Creating listening port 3333 <span class="keyword">for</span> device port 3333</span><br><span class="line">waiting <span class="keyword">for</span> connection</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>越狱设备打开包管理器 Sileo 或 Cydia 搜索 debugserver 并安装。安装好之后，我们就可以在 iOS 上运行 debugserver 了。远程登录到越狱设备，然后运行 debugserver 程序附加到微信进程。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> ~/ ssh root@localhost -p 2222</span><br><span class="line">iPhone5s:~ root# debugserver-10 localhost:3333 --attach=WeChat</span><br><span class="line">debugserver-@(#)PROGRAM:LLDB  PROJECT:lldb-10.0.0</span><br><span class="line"> <span class="keyword">for</span> arm64.</span><br><span class="line">Attaching to process WeChat...</span><br><span class="line">Listening to port 3333 <span class="keyword">for</span> a connection from localhost...</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>然后再新建一个终端窗口，进入 lldb 交互，进行连接：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> ~/ lldb</span><br><span class="line">(lldb) process connect connect://localhost:3333</span><br><span class="line">Process 11908 stopped</span><br><span class="line">* thread <span class="comment">#1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = signal SIGSTOP</span></span><br><span class="line">    frame <span class="comment">#0: 0x000000018b5840f4 libsystem_kernel.dylib`mach_msg_trap + 8</span></span><br><span class="line">libsystem_kernel.dylib`mach_msg_trap:</span><br><span class="line">-&gt;  0x18b5840f4 &lt;+8&gt;: ret</span><br><span class="line"></span><br><span class="line">libsystem_kernel.dylib`mach_msg_overwrite_trap:</span><br><span class="line">    0x18b5840f8 &lt;+0&gt;: mov    x16, <span class="comment">#-0x20</span></span><br><span class="line">    0x18b5840fc &lt;+4&gt;: svc    <span class="comment">#0x80</span></span><br><span class="line">    0x18b584100 &lt;+8&gt;: ret</span><br><span class="line">Target 0: (WeChat) stopped.</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>

<p>此时，我们就可以像在 Xcode 控制台里 po 一样调试微信了。从上面控制台的打印中或者 Reveal 里面，我们可以得到 <code>BaseMsgContentViewController</code> 的内存地址。调用对象的一个隐藏私有方法 <code>__methodDescriptionForClass:</code> 来获取它所有的方法。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">(lldb) po [0x117dad600 __methodDescriptionForClass:(<span class="built_in">id</span>)[0x117dad600 class]]</span><br><span class="line"></span><br><span class="line"><span class="keyword">in</span> BaseMsgContentViewController:</span><br><span class="line">	Class Methods:</span><br><span class="line">		+ (void) reload:(<span class="built_in">id</span>)arg1 sections:(<span class="built_in">id</span>)arg2 withRowAnimation:(long)arg3; (0x118372ef4)</span><br><span class="line">	Properties:</span><br><span class="line">		@property (weak, nonatomic) MMPageSheetAdapter* pageSheetAdapter;</span><br><span class="line">		@property (<span class="built_in">readonly</span>) unsigned long <span class="built_in">hash</span>;</span><br><span class="line">		@property (<span class="built_in">readonly</span>) Class superclass;</span><br><span class="line">		@property (<span class="built_in">readonly</span>, copy) NSString* description;</span><br><span class="line">		@property (<span class="built_in">readonly</span>, copy) NSString* debugDescription;</span><br><span class="line">		@property (<span class="built_in">readonly</span>) unsigned long <span class="built_in">hash</span>;</span><br><span class="line">		@property (<span class="built_in">readonly</span>) Class superclass;</span><br><span class="line">		@property (<span class="built_in">readonly</span>, copy) NSString* description;</span><br><span class="line">		@property (<span class="built_in">readonly</span>, copy) NSString* debugDescription;</span><br><span class="line">		@property (retain, nonatomic) MMMsgContentNavBar* tipsNavBar;  (@synthesize tipsNavBar = _tipsNavBar;)</span><br><span class="line">		@property (retain, nonatomic) MMNewMsgContentNavBar* tipsNewNavBar;  (@synthesize tipsNewNavBar = _tipsNewNavBar;)</span><br><span class="line">		@property (retain, nonatomic) MessageTipView* messageTipView;  (@synthesize messageTipView = _messageTipView;)</span><br><span class="line">		@property (retain, nonatomic) UIScreenEdgePanGestureRecognizer* popBackInteractivePopGesture;  (@synthesize popBackInteractivePopGesture = _popBackInteractivePopGesture;)</span><br><span class="line">		@property (retain, nonatomic) UIColor* chatroomBkgColor;  (@synthesize chatroomBkgColor = _chatroomBkgColor;)</span><br><span class="line">		@property (retain, nonatomic) CMessageWrap* locateMsg;  (@synthesize locateMsg = _locateMsg;)</span><br><span class="line">		@property (weak, nonatomic) &lt;BaseMsgContentDelgate&gt;* m_delegate;  (@synthesize m_delegate = m_delegate;)</span><br><span class="line">		@property (weak, nonatomic) &lt;BaseMsgContentInBackgroundThreadDelgate&gt;* m_backgroundThreadDelegate;  (@synthesize m_backgroundThreadDelegate = m_backgroundThreadDelegate;)</span><br><span class="line">		@property (retain, nonatomic) MMInputToolView* toolView;  (@synthesize toolView = _inputToolView;)</span><br><span class="line">		@property (retain, nonatomic) MMTimer* m_LockerTimer;  (@synthesize m_LockerTimer = m_LockerTimer;)</span><br><span class="line">		@property (retain, nonatomic) UIView* m_msgReceivingTipsView;  (@synthesize m_msgReceivingTipsView = m_msgReceivingTipsView;)</span><br><span class="line">		@property (retain, nonatomic) NSMutableArray* m_shareContacts;  (@synthesize m_shareContacts = m_shareContacts;)</span><br><span class="line">		@property (nonatomic) BOOL m_bIsInMainFrame;  (@synthesize m_bIsInMainFrame = _m_bIsInMainFrame;)</span><br><span class="line">		@property (nonatomic) unsigned long m_searchScene;  (@synthesize m_searchScene = m_searchScene;)</span><br><span class="line">		@property (retain, nonatomic) BadRoomLogicController* m_badRoomLogicController;  (@synthesize m_badRoomLogicController = _m_badRoomLogicController;)</span><br><span class="line">		@property (retain, nonatomic) MMRichTextCoverView* richTextCoverView;  (@synthesize richTextCoverView = _richTextCoverView;)</span><br><span class="line">		@property (retain, nonatomic) RichTextView* richTextView;  (@synthesize richTextView = _richTextView;)</span><br><span class="line">		@property (weak, nonatomic) MMInputMsgReferView* msgReferView;  (@synthesize msgReferView = _msgReferView;)</span><br><span class="line">		@property (nonatomic) unsigned int uiMultiSelectMaxCount;  (@synthesize uiMultiSelectMaxCount = _uiMultiSelectMaxCount;)</span><br><span class="line">		@property (nonatomic) unsigned int uiMultiSelectMaxMegaBytes;  (@synthesize uiMultiSelectMaxMegaBytes = _uiMultiSelectMaxMegaBytes;)</span><br><span class="line">		@property (retain, nonatomic) ChatRoomHistoryShareStat* oRoomHistoryStat;  (@synthesize oRoomHistoryStat = _oRoomHistoryStat;)</span><br><span class="line">		@property (retain, nonatomic) UIView* chatRoomDismissedView;  (@synthesize chatRoomDismissedView = _chatRoomDismissedView;)</span><br><span class="line">		@property (nonatomic) BOOL dismissWithoutReset;  (@synthesize dismissWithoutReset = _dismissWithoutReset;)</span><br><span class="line">		@property (<span class="built_in">readonly</span>) unsigned long <span class="built_in">hash</span>;</span><br><span class="line">		@property (<span class="built_in">readonly</span>) Class superclass;</span><br><span class="line">		@property (<span class="built_in">readonly</span>, copy) NSString* description;</span><br><span class="line">		@property (<span class="built_in">readonly</span>, copy) NSString* debugDescription;</span><br><span class="line">	Instance Methods:</span><br><span class="line">		- (Class) superclass; (0x11838d270)</span><br><span class="line">		- (unsigned long) <span class="built_in">hash</span>; (0x11838d204)</span><br><span class="line">		- (<span class="built_in">id</span>) description; (0x11838d144)</span><br><span class="line">		- (<span class="built_in">id</span>) debugDescription; (0x11838d084)</span><br><span class="line">		...</span><br><span class="line">		...</span><br><span class="line">		方法太多，后续都省略了</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用搜索功能，找到我们需要的方法 addMessageNode ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">		- (void) MoreMsgBtnUpdate:(unsigned int)arg1 unReadCount:(unsigned int)arg2; (0x118382ec0)</span><br><span class="line">		- (void) setM_searchScene:(unsigned long)arg1; (0x1183744a0)</span><br><span class="line">		- (void) addNoMoreMessageNode:(<span class="built_in">id</span>)arg1 addMoreMsg:(BOOL)arg2; (0x1183837f4)</span><br><span class="line">		- (void) addMessageNode:(<span class="built_in">id</span>)arg1 layout:(BOOL)arg2 addMoreMsg:(BOOL)arg3; (0x11838347c)</span><br><span class="line">		- (void) updateBanner; (0x11837a644)</span><br><span class="line">		- (long) getTextViewMarkedLength; (0x118385bb8)</span><br><span class="line">		- (void) CancelRecording; (0x11837f898)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>后面的地址就是方法实现的内存地址。对它下断点，然后让程序继续运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) breakpoint <span class="built_in">set</span> --address 0x11838347c</span><br><span class="line">Breakpoint 1: <span class="built_in">where</span> = redEnveloper.dylib`_logos_method$_ungrouped$BaseMsgContentViewController$addMessageNode$layout$addMoreMsg$(BaseMsgContentViewController*, objc_selector*, objc_object*, bool, bool) at BaseMsgContentViewController.xm:491, address = 0x000000011838347c</span><br><span class="line">(lldb) c</span><br><span class="line">Process 12265 resuming</span><br></pre></td></tr></table></figure>

<p>再次发送一条新的消息过来，就可以看到断点被命中了：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Process 12265 stopped</span><br><span class="line">* thread <span class="comment">#1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = breakpoint 1.1</span></span><br><span class="line">    frame <span class="comment">#0: 0x000000011838347c redEnveloper.dylib` _logos_method$_ungrouped$BaseMsgContentViewController$addMessageNode$layout$addMoreMsg$(self=0x0000000128322860, _cmd=&quot;\xa7\xb4\xba\U00000012\xa1%&quot;, arg1=0x000000010f1a96fa, arg2=false, arg3=false)  at BaseMsgContentViewController.xm:491</span></span><br><span class="line">   488 	- (void)onLoadMoreMessage &#123; %<span class="built_in">log</span>; %orig; &#125;</span><br><span class="line">   489 	- (void)initHistroyMessageNodeData &#123; %<span class="built_in">log</span>; %orig; &#125;</span><br><span class="line">   490 	- (void)replaceMessageNode:(<span class="built_in">id</span>)arg1 withMessageNodeList:(<span class="built_in">id</span>)arg2 &#123; %<span class="built_in">log</span>; %orig; &#125;</span><br><span class="line">-&gt; 491 	- (void)addMessageNode:(<span class="built_in">id</span>)arg1 layout:(_Bool)arg2 addMoreMsg:(_Bool)arg3 &#123; %<span class="built_in">log</span>; %orig; &#125;</span><br><span class="line">   492 	- (void)addChatViewModel:(<span class="built_in">id</span>)arg1 addMoreMsg:(_Bool)arg2 &#123; %<span class="built_in">log</span>; %orig; &#125;</span><br><span class="line">   493 	- (void)tryAddTipsNodeForInviteHistory:(<span class="built_in">id</span>)arg1 addMoreMsg:(_Bool)arg2 &#123; %<span class="built_in">log</span>; %orig; &#125;</span><br><span class="line">   494 	- (unsigned int)getNeedAddTimeWithMsgWrap:(<span class="built_in">id</span>)arg1 time:(unsigned int)arg2 &#123; %<span class="built_in">log</span>; unsigned int r = %orig; NSLog(@<span class="string">&quot; = %u&quot;</span>, r); <span class="built_in">return</span> r; &#125;</span><br><span class="line">Target 0: (WeChat) stopped.</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>

<p>奇怪的是，断点怎么跑到了 redEnveloper.dylib 的 _logos_method… 中去了，其实这就是 Theos 的原理，它将我们写的代码制作成一个 dylib 文件，然后在启动目标进程的时候，注入到目标进程中去，所以我们在 tweak 中写的代码才会被执行。而断点断在这里的原因是 BaseMsgContentViewController.xm 中对 BaseMsgContentViewController 的所有方法进行了 hook 。</p>
<p>断点命中后，接下来使用 bt 命令查看调用堆栈信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(lldb) bt</span><br><span class="line">* thread <span class="comment">#1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = breakpoint 1.1</span></span><br><span class="line">  * frame <span class="comment">#0: 0x000000011838347c redEnveloper.dylib` _logos_method$_ungrouped$BaseMsgContentViewController$addMessageNode$layout$addMoreMsg$(self=0x0000000128322860, _cmd=&quot;\xa7\xb4\xba\U00000012\xa1%&quot;, arg1=0x000000010f1a96fa, arg2=false, arg3=false)  at BaseMsgContentViewController.xm:491</span></span><br><span class="line">    frame <span class="comment">#1: 0x0000000100f83ac8 WeChat` ___lldb_unnamed_symbol12406  + 800</span></span><br><span class="line">    frame <span class="comment">#2: 0x000000010374b558 WeChat` ___lldb_unnamed_symbol184229  + 64</span></span><br><span class="line">    frame <span class="comment">#3: 0x0000000100f62ee4 WeChat` ___lldb_unnamed_symbol12051  + 624</span></span><br><span class="line">    frame <span class="comment">#4: 0x000000010df9bb70 WeChat` ___lldb_unnamed_symbol875987  + 244</span></span><br><span class="line">    frame <span class="comment">#5: 0x000000010df31348 WeChat` ___lldb_unnamed_symbol874420  + 168</span></span><br><span class="line">    frame <span class="comment">#6: 0x00000001030a7ea8 WeChat` ___lldb_unnamed_symbol157924  + 648</span></span><br><span class="line">    frame <span class="comment">#7: 0x000000010df52fd4 WeChat` ___lldb_unnamed_symbol874880  + 180</span></span><br><span class="line">    frame <span class="comment">#8: 0x000000018c47a690 Foundation` __NSThreadPerformPerform  + 336</span></span><br><span class="line">    frame <span class="comment">#9: 0x000000018b984f1c CoreFoundation` __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__  + 24</span></span><br><span class="line">    frame <span class="comment">#10: 0x000000018b984e9c CoreFoundation` __CFRunLoopDoSource0  + 88</span></span><br><span class="line">    frame <span class="comment">#11: 0x000000018b984784 CoreFoundation` __CFRunLoopDoSources0  + 176</span></span><br><span class="line">    frame <span class="comment">#12: 0x000000018b97f6c0 CoreFoundation` __CFRunLoopRun  + 1004</span></span><br><span class="line">    frame <span class="comment">#13: 0x000000018b97efb4 CoreFoundation` CFRunLoopRunSpecific  + 436</span></span><br><span class="line">    frame <span class="comment">#14: 0x000000018db8179c GraphicsServices` GSEventRunModal  + 104</span></span><br><span class="line">    frame <span class="comment">#15: 0x00000001b8211c38 UIKitCore` UIApplicationMain  + 212</span></span><br><span class="line">    frame <span class="comment">#16: 0x0000000106bc8968 WeChat` ___lldb_unnamed_symbol399385  + 956</span></span><br><span class="line">    frame <span class="comment">#17: 0x000000018b4428e0 libdyld.dylib` start  + 4</span></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>

<p>堆栈中出现了很多 ___lldb_unnamed_symbol 未命名的符号，导致我们无法知道具体的调用关系。有几种方式都可以让我们得到想要的信息。</p>
<ul>
<li><p>第一种：使用调用栈帧中的地址减去当前可执行文件在内存中的地址，就得到了这段代码在 MachO 文件中的位置，然后通过反汇编工具，Hopper，ida，ghidra 等就可以找到这段代码所属的方法是什么了。</p>
</li>
<li><p>第二种：使用 sbt，如果一次 sbt 的结果没有成功，那么多试几次，总会有些成功的。sbt 是这个 LLDB <a target="_blank" rel="noopener" href="https://github.com/DerekSelander/LLDB">插件</a>中添加的，按照提示安装之后就有了。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(lldb) sbt</span><br><span class="line">frame <span class="comment">#0 : 0x11838347c redEnveloper.dylib`_logos_method$_ungrouped$BaseMsgContentViewController$addMessageNode$layout$addMoreMsg$(BaseMsgContentViewController*, objc_selector*, objc_object*, bool, bool)</span></span><br><span class="line">frame <span class="comment">#1 : 0x100f83ac8 WeChat`-[BaseMsgContentLogicController DidAddMsg:] + 800</span></span><br><span class="line">frame <span class="comment">#2 : 0x10374b558 WeChat`-[RoomContentLogicController DidAddMsg:] + 64</span></span><br><span class="line">frame <span class="comment">#3 : 0x100f62ee4 WeChat`-[BaseMsgContentLogicController OnAddMsg:MsgWrap:] + 624</span></span><br><span class="line">frame <span class="comment">#4 : 0x10df9bb70 WeChat`-[MMExtensionCenter callExtension:selector:block:] + 244</span></span><br><span class="line">frame <span class="comment">#5 : 0x10df31348 WeChat`-[MMContext callExtension:selector:block:] + 168</span></span><br><span class="line">frame <span class="comment">#6 : 0x1030a7ea8 WeChat`-[CMessageMgr MainThreadNotifyToExt:] + 648</span></span><br><span class="line">frame <span class="comment">#7 : 0x10df52fd4 WeChat`___lldb_unnamed_symbol874880 ... unresolved womp womp + 180</span></span><br><span class="line">frame <span class="comment">#8 : 0x18c47a690 Foundation`__NSThreadPerformPerform + 336</span></span><br><span class="line">frame <span class="comment">#9 : 0x18b984f1c CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 24</span></span><br><span class="line">frame <span class="comment">#10: 0x18b984e9c CoreFoundation`__CFRunLoopDoSource0 + 88</span></span><br><span class="line">frame <span class="comment">#11: 0x18b984784 CoreFoundation`__CFRunLoopDoSources0 + 176</span></span><br><span class="line">frame <span class="comment">#12: 0x18b97f6c0 CoreFoundation`__CFRunLoopRun + 1004</span></span><br><span class="line">frame <span class="comment">#13: 0x18b97efb4 CoreFoundation`CFRunLoopRunSpecific + 436</span></span><br><span class="line">frame <span class="comment">#14: 0x18db8179c GraphicsServices`GSEventRunModal + 104</span></span><br><span class="line">frame <span class="comment">#15: 0x1b8211c38 UIKitCore`UIApplicationMain + 212</span></span><br><span class="line">frame <span class="comment">#16: 0x106bc8968 WeChat`___lldb_unnamed_symbol399385 ... unresolved womp womp + 956</span></span><br><span class="line">frame <span class="comment">#17: 0x18b4428e0 libdyld.dylib`start + 4</span></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>

<p>从调用堆栈中，看到了一个 <code>CMessageMgr</code> 类。从名称来看它叫消息管理者，一定可以从中得到更多信息。继续使用 logify.pl 将 <code>CMessageMgr</code> 类的全部方法进行 hook 并查看打印。会发现消息发送过来的时候，很多方法会执行，但是以下这个方法是比较合适的，因为能拿到消息参数。</p>
<p><img src="Xnip2024-10-13_15-21-40.jpg"></p>
<p>最终找到 -[CMessageMgr onNewSyncAddMessage:] 方法。当然不是一定要这个方法，其他任何合适的方法都可以进行抢红包的。定位到收到微信消息的方法之后，自然就是分析如何开红包了，其实从正向开发的经验可以猜测，一定是点击红包的按钮之后，发生网络请求打开红包了。</p>
<h2 id="2-定位打开红包的方法"><a href="#2-定位打开红包的方法" class="headerlink" title="2.定位打开红包的方法"></a>2.定位打开红包的方法</h2><p>这个相对来说简单一点，从 UI 入手。越狱设备点开一个红包，使用 Reveal 查看开按钮，复制按钮的内存地址，如下图:</p>
<p><img src="Xnip2024-10-10_10-30-57.png"><br><img src="Xnip2024-10-13_15-34-23.jpg"></p>
<p>我发现新版本的 Reveal 还没有老版本的好用呢，明明老版本的 Reveal 可以显示到具体的拆红包按钮，新版本却只能显示一个整体。</p>
<p>然后使用 lldb+debugserver 进行远程调试：</p>
<p>先远程登录越狱设备，使用 debugserver 附加到微信进程：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> ~/ ssh root@localhost -p 2222</span><br><span class="line">iPhone5s:~ root# debugserver-10 localhost:3333 --attach=WeChat</span><br><span class="line">debugserver-@(#)PROGRAM:LLDB  PROJECT:lldb-10.0.0</span><br><span class="line"> <span class="keyword">for</span> arm64.</span><br><span class="line">Attaching to process WeChat...</span><br><span class="line">Listening to port 3333 <span class="keyword">for</span> a connection from localhost...</span><br><span class="line">Waiting <span class="keyword">for</span> debugger instructions <span class="keyword">for</span> process 0.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>提示：这里进行了两个端口转发，一个 2222:22，另一个是 3333:3333，所以才能正常运行。<code>iproxy 2222:22 3333:3333</code></p>
</blockquote>
<p>然后进入 lldb 并调试这个按钮的 target 和 action ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> ~/ lldb</span><br><span class="line">(lldb) process connect connect://localhost:3333</span><br><span class="line">Process 12437 stopped</span><br><span class="line">* thread <span class="comment">#1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = signal SIGSTOP</span></span><br><span class="line">    frame <span class="comment">#0: 0x000000018b5840f4 libsystem_kernel.dylib` mach_msg_trap  + 8</span></span><br><span class="line">libsystem_kernel.dylib`mach_msg_trap:</span><br><span class="line">-&gt;  0x18b5840f4 &lt;+8&gt;: ret</span><br><span class="line">libsystem_kernel.dylib<span class="string">&#x27;mach_msg_overwrite_trap:    0x18b5840f8 &lt;+0&gt;: mov    x16, #-0x20</span></span><br><span class="line"><span class="string">    0x18b5840fc &lt;+4&gt;: svc    #0x80</span></span><br><span class="line"><span class="string">    0x18b584100 &lt;+8&gt;: ret</span></span><br><span class="line"><span class="string">libsystem_kernel.dylib&#x27;</span>semaphore_signal_trap:    0x18b584104 &lt;+0&gt;: mov    x16, <span class="comment">#-0x21</span></span><br><span class="line">    0x18b584108 &lt;+4&gt;: svc    <span class="comment">#0x80</span></span><br><span class="line">    0x18b58410c &lt;+8&gt;: ret</span><br><span class="line">libsystem_kernel.dylib<span class="string">&#x27;semaphore_signal_all_trap:    0x18b584110 &lt;+0&gt;: mov    x16, #-0x22</span></span><br><span class="line"><span class="string">Target 0: (WeChat) stopped.</span></span><br><span class="line"><span class="string">(lldb) po [0x1476a1000 allTargets]</span></span><br><span class="line"><span class="string">&#123;(</span></span><br><span class="line"><span class="string">    &lt;WCRedEnvelopesReceiveHomeView: 0x147693670; frame = (0 0; 320 568); clipsToBounds = YES; autoresize = W+H; layer = &lt;CALayer: 0x2829f1480&gt;&gt;</span></span><br><span class="line"><span class="string">)&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(lldb) po [0x1476a1000 actionsForTarget:0x147693670 forControlEvent:64]</span></span><br><span class="line"><span class="string">&lt;__NSArrayM 0x286397990&gt;(</span></span><br><span class="line"><span class="string">OnOpenRedEnvelopes</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(lldb)</span></span><br></pre></td></tr></table></figure>

<p>找到了 <code>-[WCRedEnvelopesReceiveHomeView OnOpenRedEnvelopes]</code> 方法。找到这个方法就能成功实现抢红包功能了吗？当然没有那么简单。我们在收到微信消息的时候，很可能连聊天页面都没有进入，更不可能存在 <code>WCRedEnvelopesReceiveHomeView</code> 对象了，所以无法调用这个方法。有人会想，我自己创建一个 <code>WCRedEnvelopesReceiveHomeView</code> 对象调用 <code>OnOpenRedEnvelopes</code> 方法能不能行呢。前提是你得知道 <code>WCRedEnvelopesReceiveHomeView</code> 正确的初始化方法啊。微信开发人员在创建 <code>WCRedEnvelopesReceiveHomeView</code> 对象的时候肯定给了其他的参数，你不能认为调用一个 <code>initWithFrame:</code> 方法创建一个 <code>WCRedEnvelopesReceiveHomeView</code> 对象之后就万事大吉了。所以还得继续分析开红包的具体代码。这就需要静态分析反汇编代码了，从汇编代码尝试还原出源码。关于 iOS 的 arm64 汇编的文章，也在准备当中。。。敬请期待</p>
<h2 id="3-静态分析开红包的方法"><a href="#3-静态分析开红包的方法" class="headerlink" title="3.静态分析开红包的方法"></a>3.静态分析开红包的方法</h2><p>定位到开红包的方法之后，需要反编译分析这个方法，看看是如何打开红包的，这就需要用到常见的反编译工具如：IDA Pro，Ghidra，Hopper Disassembler 等。这里以 Hopper 为例:</p>
<p><img src="Xnip2024-10-10_13-16-08.png"></p>
<p><code>OnOpenRedEnvelopes</code> 方法的倒数第三个 bl 跳转指令，后面指向的是 objc_msgSend 函数，如果知道了它的参数是什么，也就知道了方法最后的走向是什么。所以我们给它下一个断点，但是这个地址 0x10556c8ac 只是在 MachO 文件中的地址，实际内存中的地址，还需要加上 MachO 文件在内存中的首地址，可以使用 <code>image list -o -f WeChat</code> 来获取。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image list -o -f WeChat</span><br><span class="line">[  0] 0x000000000093c000 /var/containers/Bundle/Application/E51AA5D1-C65C-4E5B-A4AB-34C88E760D49/WeChat.app/WeChat(0x000000010093c000)</span><br></pre></td></tr></table></figure>

<p>接下来将两者相加，就可以用来下内存断点了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p/x 0x10556c8ac+0x000000000093c000</span><br><span class="line">(long) 0x0000000105ea88ac</span><br><span class="line">(lldb) breakpoint <span class="built_in">set</span> --address 0x0000000105ea88ac</span><br><span class="line">Breakpoint 1: <span class="built_in">where</span> = WeChat`___lldb_unnamed_symbol363752 + 304, address = 0x0000000105ea88ac</span><br><span class="line">(lldb) c</span><br><span class="line">Process 12437 resuming</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>

<p>断点下好之后，c 让程序继续执行，然后我们点击开红包按钮，此时断点命中，我们读取寄存器的内容：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Process 12437 stopped</span><br><span class="line">* thread <span class="comment">#1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = breakpoint 1.1</span></span><br><span class="line">    frame <span class="comment">#0: 0x0000000105ea88ac WeChat` ___lldb_unnamed_symbol363752  + 304</span></span><br><span class="line">WeChat`___lldb_unnamed_symbol363752:</span><br><span class="line">-&gt;  0x105ea88ac &lt;+304&gt;: bl     0x10853ffe4               ; ___lldb_unnamed_symbol518292</span><br><span class="line">    0x105ea88b0 &lt;+308&gt;: mov    x0, x19</span><br><span class="line">    0x105ea88b4 &lt;+312&gt;: bl     0x10853ffcc               ; ___lldb_unnamed_symbol518286</span><br><span class="line">    0x105ea88b8 &lt;+316&gt;: mov    x0, x20</span><br><span class="line">    0x105ea88bc &lt;+320&gt;: ldp    x29, x30, [sp, <span class="comment">#0x60]</span></span><br><span class="line">    0x105ea88c0 &lt;+324&gt;: ldp    x20, x19, [sp, <span class="comment">#0x50]</span></span><br><span class="line">    0x105ea88c4 &lt;+328&gt;: ldp    x22, x21, [sp, <span class="comment">#0x40]</span></span><br><span class="line">    0x105ea88c8 &lt;+332&gt;: ldp    x24, x23, [sp, <span class="comment">#0x30]</span></span><br><span class="line">Target 0: (WeChat) stopped.</span><br><span class="line">(lldb) register <span class="built_in">read</span> x0</span><br><span class="line">      x0 = 0x0000000281d49a40</span><br><span class="line">(lldb) po 0x0000000281d49a40</span><br><span class="line">&lt;WCRedEnvelopesReceiveControlLogic: 0x281d49a40&gt;</span><br><span class="line"></span><br><span class="line">(lldb) register <span class="built_in">read</span> x1</span><br><span class="line">      x1 = 0x000000010f1c6cc5  <span class="string">&quot;WCRedEnvelopesReceiveHomeViewOpenRedEnvelopes&quot;</span></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>

<p>通过对寄存器的读取，我们得知此时，调用了 <code>-[WCRedEnvelopesReceiveControlLogic WCRedEnvelopesReceiveHomeViewOpenRedEnvelopes]</code> 方法。终于来到了真正开红包的地方了！以及红包相关的逻辑处理的类 <code>WCRedEnvelopesReceiveControlLogic</code>。</p>
<p>继续查看反汇编之后的代码，可以看出这个方法中，拼接了一个字典参数，然后通过调用 <code>OpenRedEnvelopesRequest:</code> 方法发送了请求。</p>
<p>使用 logify.pl 将 <code>WCRedEnvelopesReceiveControlLogic</code> 的所有方法进行 hook，这下我们可以清晰的看到开红包的过程了。在聊天界面点击红包的时候，首先会调用查红包的接口 <code>ReceiverQueryRedEnvelopesRequest:</code> 它返回了一个重要的参数 <code>timingIdentifier</code>，之后显示了开红包的界面，点击开按钮才是开红包的请求 <code>OpenRedEnvelopesRequest:</code>，用到了这个参数。</p>
<h2 id="最终代码"><a href="#最终代码" class="headerlink" title="最终代码"></a>最终代码</h2><p>此时，我们的需要做的就是将逻辑完善。在收到微信消息的时候，判断是红包消息就发送一个查红包的请求，在它的响应回来的时候，判断是否开了自动抢红包，开了就调用开红包的请求。这就是自动抢红包的完整逻辑了。还有判断是否是红包消息，是否是未拆开的红包等判断逻辑也不用我们自己去猜，微信肯定有它自己的判断，我们只需要找到对应的代码拿过来用就行了，但这都是些小细节了就不再深入了。</p>
<p>最终的完整代码下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WCTableViewManager</span></span></span><br><span class="line">- (<span class="type">long</span> <span class="type">long</span>)numberOfSectionsInTableView:(<span class="type">id</span>)arg1;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSMutableDictionary</span> (<span class="title">safeSetObject</span>)</span></span><br><span class="line">- (<span class="type">void</span>)safeSetObject:(<span class="type">id</span>)arg1 forKey:(<span class="type">id</span>)arg2;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WCBizUtil</span></span></span><br><span class="line">+ (<span class="type">id</span>)dictionaryWithDecodedComponets:(<span class="type">id</span>)arg1 separator:(<span class="type">id</span>)arg2;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SKBuiltinBuffer_t</span></span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSData</span> *buffer; <span class="comment">// @dynamic buffer;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="type">unsigned</span> <span class="type">int</span> iLen; <span class="comment">// @dynamic iLen;</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">BaseRequest</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HongBaoReq</span></span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) BaseRequest *baseRequest; <span class="comment">// @dynamic baseRequest;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="type">unsigned</span> <span class="type">int</span> cgiCmd; <span class="comment">// @dynamic cgiCmd;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="type">unsigned</span> <span class="type">int</span> outPutType; <span class="comment">// @dynamic outPutType;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">SKBuiltinBuffer_t</span> *reqText; <span class="comment">// @dynamic reqText;</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HongBaoRes</span></span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="type">int</span> cgiCmdid; <span class="comment">// @dynamic cgiCmdid;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *errorMsg; <span class="comment">// @dynamic errorMsg;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="type">int</span> errorType; <span class="comment">// @dynamic errorType;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *platMsg; <span class="comment">// @dynamic platMsg;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="type">int</span> platRet; <span class="comment">// @dynamic platRet;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">SKBuiltinBuffer_t</span> *retText; <span class="comment">// @dynamic retText;</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CContact</span></span></span><br><span class="line">- (<span class="type">id</span>)getContactDisplayName;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsHeadImgUrl;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CContactMgr</span></span></span><br><span class="line">- (<span class="type">id</span>)getSelfContact;</span><br><span class="line">- (<span class="type">id</span>)getContactByNameFromCache:(<span class="type">id</span>)cache;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WCRedEnvelopesLogicMgr</span></span></span><br><span class="line">- (<span class="type">void</span>)ReceiverQueryRedEnvelopesRequest:(<span class="type">id</span>)arg1;</span><br><span class="line">- (<span class="type">void</span>)OpenRedEnvelopesRequest:(<span class="type">id</span>)arg1;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MMContext</span></span></span><br><span class="line">+ (<span class="type">id</span>)currentContext;</span><br><span class="line">- (<span class="type">id</span>)getService:(Class)arg1;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MMMsgLogicManager</span></span></span><br><span class="line">- (<span class="built_in">UIViewController</span> *)GetCurrentLogicController;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WCPayInfoItem</span></span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_c2cNativeUrl;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CMessageWrap</span></span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) WCPayInfoItem *m_oWCPayInfoItem;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsRealChatUsr;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsFromUsr;</span><br><span class="line">- (<span class="type">void</span>)parseWCPayInfoItemIfNeed;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WCPayC2CMessageViewModel</span></span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CMessageWrap</span> *messageWrap;</span><br><span class="line">+ (<span class="type">BOOL</span>)canCreateMessageViewModelWithMessageWrap:(<span class="type">id</span>)wrap;</span><br><span class="line">+ (<span class="type">id</span>)createMessageViewModelWithMessageWrap:(<span class="type">id</span>)arg1 contact:(<span class="type">id</span>)arg2 chatContact:(<span class="type">id</span>)arg3;</span><br><span class="line">- (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)bubbleType;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 界面代码</span></span><br><span class="line">%hook WCTableViewManager</span><br><span class="line">- (<span class="type">double</span>)tableView:(<span class="built_in">UITableView</span> *)tableView heightForRowAtIndexPath:(<span class="type">id</span>)indexPath&#123;</span><br><span class="line">    <span class="keyword">if</span>([tableView.nextResponder.nextResponder isKindOfClass:%c(NewSettingViewController)]</span><br><span class="line">       &amp;&amp;([indexPath section] == [<span class="keyword">self</span> numberOfSectionsInTableView:tableView] - <span class="number">1</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">44</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="type">id</span>)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="type">id</span>)indexPath&#123;</span><br><span class="line">    <span class="keyword">if</span>([tableView.nextResponder.nextResponder isKindOfClass:%c(NewSettingViewController)]</span><br><span class="line">       &amp;&amp;([indexPath section] == [<span class="keyword">self</span> numberOfSectionsInTableView:tableView] - <span class="number">1</span>))&#123;</span><br><span class="line">        <span class="built_in">UITableViewCell</span> * cell = [[<span class="built_in">UITableViewCell</span> alloc] initWithStyle:(<span class="built_in">UITableViewCellStyleDefault</span>) reuseIdentifier:<span class="literal">nil</span>];</span><br><span class="line">        cell.backgroundColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line">        <span class="keyword">if</span>([indexPath row] == <span class="number">0</span>)&#123;</span><br><span class="line">            cell.textLabel.text = <span class="string">@&quot;自动抢红包&quot;</span>;</span><br><span class="line">            <span class="built_in">UISwitch</span> * switchView = [[<span class="built_in">UISwitch</span> alloc] init];</span><br><span class="line">            switchView.on = [[<span class="built_in">NSUserDefaults</span> standardUserDefaults] boolForKey:<span class="string">@&quot;RESWITCHKEY&quot;</span>];</span><br><span class="line">            [switchView addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(switchChang:) forControlEvents:(<span class="built_in">UIControlEventValueChanged</span>)];</span><br><span class="line">            cell.accessoryView = switchView;</span><br><span class="line">            <span class="built_in">NSBundle</span> *bundle = [<span class="built_in">NSBundle</span> bundleWithPath:<span class="string">@&quot;/Library/MobileSubstrate/DynamicLibraries/redEnveloper.bundle/&quot;</span>];</span><br><span class="line">            <span class="built_in">NSString</span> *imageName = ([[<span class="built_in">NSUserDefaults</span> standardUserDefaults] boolForKey:<span class="string">@&quot;RESWITCHKEY&quot;</span>] == <span class="number">1</span>) ? <span class="string">@&quot;locked.png&quot;</span> : <span class="string">@&quot;unlocked.png&quot;</span>;</span><br><span class="line">            <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageNamed:imageName inBundle:bundle compatibleWithTraitCollection:<span class="literal">nil</span>];</span><br><span class="line">            cell.imageView.image = image;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cell;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="type">long</span> <span class="type">long</span>)tableView:(<span class="built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="type">long</span> <span class="type">long</span>)section&#123;</span><br><span class="line">    <span class="keyword">if</span>([tableView.nextResponder.nextResponder isKindOfClass:%c(NewSettingViewController)]</span><br><span class="line">       &amp;&amp;(section == [<span class="keyword">self</span> numberOfSectionsInTableView:tableView] - <span class="number">1</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="type">long</span> <span class="type">long</span>)numberOfSectionsInTableView:(<span class="built_in">UITableView</span> *)tableView&#123;</span><br><span class="line">    <span class="keyword">if</span>([tableView.nextResponder.nextResponder isKindOfClass:%c(NewSettingViewController)])&#123;</span><br><span class="line">        <span class="keyword">return</span> %orig+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br><span class="line">%new</span><br><span class="line">-(<span class="type">void</span>)switchChang:(<span class="built_in">UISwitch</span> *)switchView&#123;</span><br><span class="line">    [[<span class="built_in">NSUserDefaults</span> standardUserDefaults] setBool:switchView.isOn forKey:<span class="string">@&quot;RESWITCHKEY&quot;</span>];</span><br><span class="line">    [[<span class="built_in">NSUserDefaults</span> standardUserDefaults] synchronize];</span><br><span class="line">    [MSHookIvar&lt;<span class="built_in">UITableView</span> *&gt;(<span class="keyword">self</span>,<span class="string">&quot;_tableView&quot;</span>) reloadData];</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line"><span class="comment">// 功能实现代码</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AutoGrabRedEnvelopeMgr</span> : <span class="title">NSObject</span></span>&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *_array;<span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)shared;</span><br><span class="line">- (<span class="type">BOOL</span>)isEmpty;</span><br><span class="line">- (<span class="type">void</span>)enqueueDictionary:(<span class="built_in">NSDictionary</span> *)parameter;</span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)dequeueDictionary;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AutoGrabRedEnvelopeMgr</span></span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)shared&#123;</span><br><span class="line">    <span class="keyword">static</span> AutoGrabRedEnvelopeMgr *mgr = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        mgr = [[[<span class="keyword">self</span> <span class="keyword">class</span>] alloc] init];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> mgr;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _array = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="type">BOOL</span>)isEmpty &#123;</span><br><span class="line">    <span class="keyword">return</span> _array.count == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="type">void</span>)enqueueDictionary:(<span class="built_in">NSDictionary</span> *)parameter &#123;</span><br><span class="line">    [_array addObject:parameter];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)dequeueDictionary &#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> isEmpty]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSDictionary</span> *dict = [_array firstObject];</span><br><span class="line">        [_array removeObjectAtIndex:<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> dict;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初步分析每次收到消息的时候,都会调用到这个方法,那么就可以在这个方法里面进行抢红包;</span></span><br><span class="line">%hook <span class="built_in">CMessageMgr</span></span><br><span class="line">- (<span class="type">void</span>)onNewSyncAddMessage:(<span class="type">id</span>)arg1 &#123; <span class="comment">//CMessageWrap</span></span><br><span class="line">    <span class="comment">// 需要判断一下是否是红包消息,不然每次一有消息过来就去拆红包开红包不合理</span></span><br><span class="line">    <span class="keyword">if</span> ([%c(WCPayC2CMessageViewModel) canCreateMessageViewModelWithMessageWrap:arg1]) &#123; <span class="comment">// 这里确定是红包消息</span></span><br><span class="line">        WCPayC2CMessageViewModel *model = [%c(WCPayC2CMessageViewModel) createMessageViewModelWithMessageWrap:arg1 contact:<span class="literal">nil</span> chatContact:<span class="literal">nil</span>];</span><br><span class="line">        [model.messageWrap parseWCPayInfoItemIfNeed];</span><br><span class="line">        <span class="keyword">if</span> (model.bubbleType == <span class="number">4</span>) &#123; <span class="comment">// 未打开的红包</span></span><br><span class="line">            <span class="keyword">if</span> ([[<span class="built_in">NSUserDefaults</span> standardUserDefaults] boolForKey:<span class="string">@&quot;RESWITCHKEY&quot;</span>]) &#123; <span class="comment">// 打开了自动抢红包</span></span><br><span class="line">                <span class="built_in">NSString</span> *m_c2cNativeUrl = model.messageWrap.m_oWCPayInfoItem.m_c2cNativeUrl;</span><br><span class="line">                <span class="built_in">NSUInteger</span> len = [<span class="string">@&quot;wxpay://c2cbizmessagehandler/hongbao/receivehongbao?&quot;</span> length];</span><br><span class="line">                <span class="built_in">NSString</span> * substring = [m_c2cNativeUrl substringFromIndex:len];</span><br><span class="line">                <span class="built_in">NSDictionary</span> * dict = [%c(WCBizUtil) dictionaryWithDecodedComponets:substring separator:<span class="string">@&quot;&amp;&quot;</span>];</span><br><span class="line">                <span class="built_in">NSMutableDictionary</span> * parameter = [%c(<span class="built_in">NSMutableDictionary</span>) dictionary];</span><br><span class="line">                [parameter safeSetObject:<span class="string">@&quot;1&quot;</span> forKey:<span class="string">@&quot;msgType&quot;</span>];</span><br><span class="line">                [parameter safeSetObject:[dict objectForKey:<span class="string">@&quot;sendid&quot;</span>] forKey:<span class="string">@&quot;sendId&quot;</span>];</span><br><span class="line">                [parameter safeSetObject:[dict objectForKey:<span class="string">@&quot;channelid&quot;</span>] forKey:<span class="string">@&quot;channelId&quot;</span>];</span><br><span class="line">                [parameter safeSetObject:m_c2cNativeUrl forKey:<span class="string">@&quot;nativeUrl&quot;</span>];</span><br><span class="line">                MMMsgLogicManager *msgLogicMgr = [[%c(MMContext) currentContext] getService:[%c(MMMsgLogicManager) <span class="keyword">class</span>]];</span><br><span class="line">                <span class="built_in">UIViewController</span> * vc = [msgLogicMgr GetCurrentLogicController];</span><br><span class="line">                <span class="built_in">NSString</span> *inWay;</span><br><span class="line">                <span class="keyword">if</span> (vc == <span class="literal">nil</span> || [vc valueForKey:<span class="string">@&quot;m_contact&quot;</span>] == <span class="literal">nil</span> || ![[vc valueForKey:<span class="string">@&quot;m_contact.isChatroom&quot;</span>] boolValue]) &#123;</span><br><span class="line">                    inWay = <span class="string">@&quot;1&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    inWay = <span class="string">@&quot;0&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                [parameter safeSetObject:inWay forKey:<span class="string">@&quot;inWay&quot;</span>];</span><br><span class="line">                [parameter safeSetObject:<span class="string">@&quot;0&quot;</span> forKey:<span class="string">@&quot;agreeDuty&quot;</span>];</span><br><span class="line">                WCRedEnvelopesLogicMgr *mgr = [[%c(MMContext) currentContext] getService:[%c(WCRedEnvelopesLogicMgr) <span class="keyword">class</span>]];</span><br><span class="line">                [mgr ReceiverQueryRedEnvelopesRequest:[parameter <span class="keyword">copy</span>]];</span><br><span class="line">                [parameter safeSetObject:model.messageWrap.m_nsFromUsr forKey:<span class="string">@&quot;sessionUserName&quot;</span>];</span><br><span class="line">                [AutoGrabRedEnvelopeMgr.shared enqueueDictionary:parameter];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    %orig;</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%hook WCRedEnvelopesLogicMgr</span><br><span class="line">- (<span class="type">void</span>)OnWCToHongbaoCommonResponse:(HongBaoRes *)arg1 Request:(HongBaoReq *)arg2&#123;</span><br><span class="line">    %orig;</span><br><span class="line">    <span class="built_in">NSError</span> *error;</span><br><span class="line">    <span class="built_in">NSDictionary</span> *response = [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:arg1.retText.buffer options:<span class="built_in">NSJSONReadingMutableContainers</span> error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (arg1.cgiCmdid == <span class="number">3</span>) &#123; <span class="comment">// 表示拆红包,开红包的前一个步骤</span></span><br><span class="line">        <span class="keyword">if</span> (![AutoGrabRedEnvelopeMgr.shared isEmpty] &amp;&amp; [response[<span class="string">@&quot;timingIdentifier&quot;</span>] length] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *dic = [AutoGrabRedEnvelopeMgr.shared dequeueDictionary].mutableCopy;</span><br><span class="line">            dic[<span class="string">@&quot;timingIdentifier&quot;</span>] = response[<span class="string">@&quot;timingIdentifier&quot;</span>];</span><br><span class="line">            MMContext *context = [%c(MMContext) currentContext];</span><br><span class="line">            CContactMgr *contactMgr = [context getService:[%c(CContactMgr) <span class="keyword">class</span>]];</span><br><span class="line">            CContact *contact = [contactMgr getSelfContact];</span><br><span class="line">            <span class="built_in">NSString</span> *displayName = [contact getContactDisplayName];</span><br><span class="line">            [dic setObject:displayName forKey:<span class="string">@&quot;nickName&quot;</span>];</span><br><span class="line">            <span class="built_in">NSString</span> *headImgUrl = [contact m_nsHeadImgUrl];</span><br><span class="line">            [dic setObject:headImgUrl forKey:<span class="string">@&quot;headImg&quot;</span>];</span><br><span class="line">            <span class="keyword">if</span> ([dic objectForKey:<span class="string">@&quot;agreeDuty&quot;</span>]) [dic removeObjectForKey:<span class="string">@&quot;agreeDuty&quot;</span>];</span><br><span class="line">            <span class="keyword">if</span> ([dic objectForKey:<span class="string">@&quot;inWay&quot;</span>]) [dic removeObjectForKey:<span class="string">@&quot;inWay&quot;</span>];</span><br><span class="line">            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">0.5</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [<span class="keyword">self</span> OpenRedEnvelopesRequest:dic]; </span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>代码完成之后，我们进入终端，cd 到项目的文件夹下，编译打包安装之后，再次进入微信，找到自动抢红包的开关，打开之后，给这个微信账号发送一个红包试试有没有成功！</p>
<p>可以看到实现自动抢红包的 UI 和功能的代码并不是很多，仅仅 200 多行，但是这 200 多行的代码要能自己写出来也是真的挺不容易的。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://masterking.github.io">masterKing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://masterking.github.io/2024/04/10/%E5%BE%AE%E4%BF%A1%E6%8A%A2%E7%BA%A2%E5%8C%85%E6%8F%92%E4%BB%B6/">https://masterking.github.io/2024/04/10/微信抢红包插件/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://masterking.github.io" target="_blank">masterKing 的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/iOS/">iOS</a><a class="post-meta__tags" href="/tags/%E9%80%86%E5%90%91/">逆向</a><a class="post-meta__tags" href="/tags/%E5%BE%AE%E4%BF%A1/">微信</a><a class="post-meta__tags" href="/tags/%E6%8F%92%E4%BB%B6/">插件</a></div><div class="post-share"><div class="social-share" data-image="/images/iOSReveseEngineeringAndSecurity1.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/03/27/iOS%E9%80%86%E5%90%91%E4%B8%8E%E5%AE%89%E5%85%A8%E5%BC%80%E7%AF%87%E4%BB%8B%E7%BB%8D/" title="iOS逆向与安全开篇介绍"><img class="cover" src="/images/iOSReveseEngineeringAndSecurity1.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">iOS逆向与安全开篇介绍</div></div><div class="info-2"><div class="info-item-1">学习 iOS 逆向开发的前提 有一定的正向开发经验（最起码对 iOS 系统的 UIKit 框架有一定的了解） 一台越狱的 iOS 设备（推荐至少是 64 位架构，iPhone 是从 iPhone 5s 开始，iPad 是从 iPad Air 和 iPad mini 2 开始） 一台 Mac 电脑，理论上来说 Linux 或 Windows...</div></div></div></a><a class="pagination-related" href="/2024/10/27/iOS-%E5%BA%94%E7%94%A8%E7%A0%B8%E5%A3%B3/" title="iOS 应用砸壳"><img class="cover" src="/images/iOSReveseEngineeringAndSecurity1.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">iOS 应用砸壳</div></div><div class="info-2"><div class="info-item-1">什么是壳在软件保护和安全领域，“壳”指的是利用特殊的算法对应用程序的二进制文件进行加密或包装的保护层，通常被称为 “加壳”。壳的作用是保护应用程序的代码，防止未经授权的访问、篡改和逆向工程。壳通常会在应用程序启动时将其解密到内存中，以便正常运行。 苹果会在应用发布到 App Store 时，对应用程序进行 DRM（数字版权管理）保护，这种保护即一种壳，目的是防止非法分发。所以从 App...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2019/04/04/2019-04-04-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="设计模式"><img class="cover" src="https://inews.gtimg.com/om_bt/Os3eJ8u3SgB3Kd-zrRRhgfR5hUvdwcVPKUTNO6O7sZfUwAA/641" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-04-04</div><div class="info-item-2">设计模式</div></div><div class="info-2"><div class="info-item-1">#关于设计模式    * * 创建型 结构型 行为型    范围 类 Factory Method Adapter(类) InterpreterTemplate Method   * 对象 Abstract...</div></div></div></a><a class="pagination-related" href="/2019/04/12/2019-04-12-OC%E4%B8%8EiOS%E6%B7%B7%E7%BC%96/" title="OC与iOS混编"><img class="cover" src="https://inews.gtimg.com/om_bt/Os3eJ8u3SgB3Kd-zrRRhgfR5hUvdwcVPKUTNO6O7sZfUwAA/641" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-04-12</div><div class="info-item-2">OC与iOS混编</div></div><div class="info-2"><div class="info-item-1">记录一下,OC和Swift混编的问题在OC项目中,需要使用Swift的时候,一般情况下,在你的OC项目中新建一个Swift文件的时候,系统会自动提示你是否需要配置一个Objective-C桥接头文件,如下图</div></div></div></a><a class="pagination-related" href="/2018/04/03/Error-Domain-NSURLErrorDomain-Code-999-%E5%B7%B2%E5%8F%96%E6%B6%88/" title="Error Domain&#x3D;NSURLErrorDomain Code&#x3D;-999 已取消"><img class="cover" src="https://inews.gtimg.com/om_bt/Os3eJ8u3SgB3Kd-zrRRhgfR5hUvdwcVPKUTNO6O7sZfUwAA/641" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-04-03</div><div class="info-item-2">Error Domain&#x3D;NSURLErrorDomain Code&#x3D;-999 已取消</div></div><div class="info-2"><div class="info-item-1">今天遇到这么一个问题,在使用 SDWebimage 设置 UIImageView 的图片的时候,发现这个图片http://img4.imgtn.bdimg.com/it/u=132600321,3123081067&amp;fm=27&amp;gp=0.jpg怎么也设置不成功,后来调试一看发现  说是什么已取消,我是一脸懵逼啊,谁 TM...</div></div></div></a><a class="pagination-related" href="/2018/04/28/iPhoneX%E4%B8%8Apop%E5%9B%9E%E5%88%B0%E6%A0%B9%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B8%8A%E6%BC%82%E7%A7%BB%E7%9A%84bug/" title="iPhoneX上pop回到根控制器上漂移的bug"><img class="cover" src="https://inews.gtimg.com/om_bt/Os3eJ8u3SgB3Kd-zrRRhgfR5hUvdwcVPKUTNO6O7sZfUwAA/641" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-04-28</div><div class="info-item-2">iPhoneX上pop回到根控制器上漂移的bug</div></div><div class="info-2"><div class="info-item-1">记录一个在 iPhone X 上发生的诡异的 bug…语言怎么描述都太苍白,那么直接看图  只有在滑动到最底部的时候,push 到下一个页面,然后在 pop 回来就会出现 contentOffset.y 值自动偏移的现象… 视图的层次结构如图:  选中的视图控制器就是 TabBarController 的第二个子控制器,控制器的 view 就是一个...</div></div></div></a><a class="pagination-related" href="/2021/06/10/%E5%AF%86%E7%A0%81%E5%AD%A6%E6%A6%82%E8%BF%B0/" title="密码学概述"><img class="cover" src="/images/iOSReveseEngineeringAndSecurity1.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="info-item-2">密码学概述</div></div><div class="info-2"><div class="info-item-1">密码学（来自希腊语kryptos，意思是隐藏）一词的核心是指使数据无法被窥探者读取的技术。当然，密码学也可以用于其他目的。密码学包括一系列技术，如验证数据的真实性（检测是否修改）、确定个人或其他实体的身份、确定谁发送了特定消息或创建了特定数据片段、通过网络安全地发送数据、用密码或口令安全地锁定文件等等。</div></div></div></a><a class="pagination-related" href="/2018/03/26/%E6%8F%AD%E7%A7%98iOS%E5%B8%83%E5%B1%80/" title="揭开神秘的iOS布局"><img class="cover" src="https://inews.gtimg.com/om_bt/OVx3YS2XJc1zbndGTkjPKW9J0W7kN8M0SIidT-3K4mb2YAA/641" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-03-26</div><div class="info-item-2">揭开神秘的iOS布局</div></div><div class="info-2"><div class="info-item-1">翻译自: Demystifying iOS Layout 在你刚开始开发iOS应用时,最难避免或者说最难调试的是处理视图的布局和内容;通常这些事情的发生是因为对 视图更新 真实发生存在误解;了解 视图更新...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B6%8A%E7%8B%B1-iPhone"><span class="toc-text">越狱 iPhone</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-iPhone-%E8%B6%8A%E7%8B%B1"><span class="toc-text">什么是 iPhone 越狱</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%8A%E7%8B%B1%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-text">越狱的原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%8A%E7%8B%B1%E7%9A%84%E4%B8%BB%E8%A6%81%E7%9B%AE%E7%9A%84"><span class="toc-text">越狱的主要目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%8A%E7%8B%B1%E5%90%8E%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">越狱后的注意事项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iOS-%E8%B6%8A%E7%8B%B1%E7%9A%84%E5%9B%9B%E7%A7%8D%E7%B1%BB%E5%9E%8B"><span class="toc-text">iOS 越狱的四种类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-text">包管理器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Sileo"><span class="toc-text">Sileo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cydia"><span class="toc-text">Cydia</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%8A%E7%8B%B1%E5%90%8E%E5%B8%B8%E7%94%A8%E7%9A%84%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="toc-text">越狱后常用的软件包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iOS-%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E8%AE%BE%E5%A4%87%E6%98%AF%E5%90%A6%E8%B6%8A%E7%8B%B1"><span class="toc-text">iOS 如何判断设备是否越狱</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E7%9A%84%E5%AD%98%E5%9C%A8"><span class="toc-text">检查系统文件的存在</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E8%83%BD%E5%A4%9F%E8%AE%BF%E9%97%AE%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%A0%B9%E7%9B%AE%E5%BD%95"><span class="toc-text">检查是否能够访问系统的根目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E5%8F%AF%E4%BB%A5%E8%B0%83%E7%94%A8-fork-%E5%87%BD%E6%95%B0"><span class="toc-text">检查是否可以调用 fork() 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E8%B6%8A%E7%8B%B1%E5%B7%A5%E5%85%B7%E7%9A%84%E5%AD%98%E5%9C%A8"><span class="toc-text">检测越狱工具的存在</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%8A%A8%E6%80%81%E5%BA%93%E6%B3%A8%E5%85%A5"><span class="toc-text">检查动态库注入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%84%B1%E5%A3%B3%E5%BE%AE%E4%BF%A1"><span class="toc-text">脱壳微信</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%89%8B%E6%9C%BA%E5%AE%89%E8%A3%85-frida"><span class="toc-text">1.手机安装 frida</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Mac%E4%B8%8B%E8%BD%BD-frida-ios-dump-%E9%A1%B9%E7%9B%AE"><span class="toc-text">2.Mac下载 frida-ios-dump 项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AE%89%E8%A3%85-frida-ios-dump-%E7%9A%84%E4%BE%9D%E8%B5%96%E5%BA%93"><span class="toc-text">3.安装 frida-ios-dump 的依赖库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%BF%9B%E8%A1%8C%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-text">4.进行端口转发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%BF%90%E8%A1%8C-dump-py-%E8%84%9A%E6%9C%AC"><span class="toc-text">5.运行 dump.py 脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Theos-%E5%88%9B%E5%BB%BA%E6%8A%A2%E7%BA%A2%E5%8C%85-tweak-%E9%A1%B9%E7%9B%AE"><span class="toc-text">安装 Theos 创建抢红包 tweak 项目</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%8A%A2%E7%BA%A2%E5%8C%85%E6%8F%92%E4%BB%B6%E7%9A%84-UI-%E4%BB%A3%E7%A0%81"><span class="toc-text">实现抢红包插件的 UI 代码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%8A%A2%E7%BA%A2%E5%8C%85%E6%8F%92%E4%BB%B6%E7%9A%84%E5%8A%9F%E8%83%BD%E4%BB%A3%E7%A0%81"><span class="toc-text">实现抢红包插件的功能代码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%AE%9A%E4%BD%8D%E6%94%B6%E5%88%B0%E5%BE%AE%E4%BF%A1%E6%B6%88%E6%81%AF%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-text">1.定位收到微信消息的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AE%9A%E4%BD%8D%E6%89%93%E5%BC%80%E7%BA%A2%E5%8C%85%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-text">2.定位打开红包的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90%E5%BC%80%E7%BA%A2%E5%8C%85%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-text">3.静态分析开红包的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E4%BB%A3%E7%A0%81"><span class="toc-text">最终代码</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url(/images/iOSReveseEngineeringAndSecurity1.webp);"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2024 By masterKing</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Nj4rbGaJ3pAWBRJWseaRg9Zu-gzGzoHsz',
      appKey: '3tVispErrQeAytUHyJrFos3n',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await btf.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>